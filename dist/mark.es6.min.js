/*!***************************************************
* advanced-mark.js v2.0.0
* https://github.com/angezid/advanced-mark#readme
* MIT licensed
* Copyright (c) 2022–2023, angezid
* Original author Julian Kühnel, license https://git.io/vwTVl
*****************************************************/
class t{constructor(t,e){this.ctx=t,this.opt=e,this.attrName="data-markjsListener"}static matches(t,e){const s="string"==typeof e?[e]:e;if(!s)return!1;const r=t.matches||t.matchesSelector||t.msMatchesSelector||t.mozMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector;return!!r&&s.some((e=>!0===r.call(t,e)))}getContexts(){let t;t=void 0!==this.ctx&&this.ctx?NodeList.prototype.isPrototypeOf(this.ctx)?Array.prototype.slice.call(this.ctx):Array.isArray(this.ctx)?this.ctx:"string"==typeof this.ctx?Array.prototype.slice.call(document.querySelectorAll(this.ctx)):[this.ctx]:[];const e=[];return t.forEach((t=>{-1!==e.indexOf(t)||e.some((e=>e.contains(t)))||e.push(t)})),e}getIframeContents(t,e,s){try{const s=t.contentWindow.document;s&&(t.setAttribute(this.attrName,"completed"),e({iframe:t,context:s}))}catch(e){t.setAttribute(this.attrName,"error"),s({iframe:t,error:e})}}isIframeBlank(t){const e="about:blank",s=t.getAttribute("src").trim();return t.contentWindow.location.href===e&&s!==e&&s}observeIframeLoad(t,e,s){if(t.hasAttribute(this.attrName))return;let r=null;const a=()=>{clearTimeout(r),t.removeEventListener("load",a),this.getIframeContents(t,e,s)};t.addEventListener("load",a),t.setAttribute(this.attrName,!0),r=setTimeout(a,this.opt.iframesTimeout)}onIframeReady(t,e,s){try{"complete"===t.contentWindow.document.readyState?this.isIframeBlank(t)?this.observeIframeLoad(t,e,s):this.getIframeContents(t,e,s):this.observeIframeLoad(t,e,s)}catch(t){s(t)}}waitForAllIframes(e,s){let r=0,a=[],o=[],i=!1;const n=setTimeout((()=>{i=!0,s()}),this.opt.iframesTimeout),h=()=>{clearTimeout(n),i||s()},c=()=>{r===a.filter((t=>!this.hasAttributeValue(t,this.attrName,"error"))).length&&h()},l=e=>{e.iframe&&"about:blank"===e.context.location.href||(o=[],e.context.querySelectorAll(e.iframe?"body iframe":"iframe").forEach((e=>{t.matches(e,this.opt.exclude)||(a.push(e),e.hasAttribute(this.attrName)||o.push(e))})),e.iframe||o.length)?o.length?o.forEach((t=>{this.onIframeReady(t,(t=>{r++,l(t)}),(t=>{this.opt.debug&&console.log(t.error),c()}))})):c():h()};l({context:e})}createIterator(t,e,s){return document.createNodeIterator(t,e,s,!1)}addRemoveStyle(t,e,s){if(s){if(!e||!t.firstChild||t.querySelector("style[data-markjs]"))return;t.insertBefore(e,t.firstChild)}else{let e=t.querySelector("style[data-markjs]");e&&t.removeChild(e)}}createStyleElement(){const t=document.createElement("style");return t.setAttribute("data-markjs","true"),t.textContent=this.opt.shadowDOM.style,t}hasAttributeValue(t,e,s){return t.hasAttribute(e)&&t.getAttribute(e)===s}iterateThroughNodes(e,s,r,a,o){const i=this.opt.shadowDOM,n=this.opt.iframes;if(n||i){const o=0!=(s&NodeFilter.SHOW_ELEMENT),h=0!=(s&NodeFilter.SHOW_TEXT),c=i&&i.style?this.createStyleElement():null;h&&(s=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT);const l=e=>{const d=this.createIterator(e,s);for(;e=d.nextNode();)e.nodeType===Node.ELEMENT_NODE?(o&&r(e)===NodeFilter.FILTER_ACCEPT&&a(e),n&&"IFRAME"===e.nodeName.toUpperCase()&&!t.matches(e,this.opt.exclude)&&this.hasAttributeValue(e,this.attrName,"completed")&&this.getIframeContents(e,(t=>{l(t.context)}),(()=>{})),i&&e.shadowRoot&&"open"===e.shadowRoot.mode&&(this.addRemoveStyle(e.shadowRoot,c,h),l(e.shadowRoot))):h&&e.nodeType===Node.TEXT_NODE&&r(e)===NodeFilter.FILTER_ACCEPT&&a(e)};l(e)}else{const t=this.createIterator(e,s,r);let o;for(;o=t.nextNode();)a(o)}o()}forEachNode(t,e,s,r=(()=>{})){const a=this.getContexts();let o=a.length;o||r(),a.forEach((a=>{o--;const i=()=>{this.iterateThroughNodes(a,t,s,e,(()=>{o<=0&&r()}))};this.opt.iframes?this.waitForAllIframes(a,i):i()}))}}class e{constructor(t){this.opt=Object.assign({},{diacritics:!0,synonyms:{},accuracy:"partially",caseSensitive:!1,ignoreJoiners:!1,ignorePunctuation:[],wildcards:"disabled"},t)}create(t,e){return"disabled"!==this.opt.wildcards&&(t=this.setupWildcardsRegExp(t)),t=this.escapeStr(t),Object.keys(this.opt.synonyms).length&&(t=this.createSynonymsRegExp(t)),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(t=this.setupIgnoreJoinersRegExp(t)),this.opt.diacritics&&(t=this.createDiacriticsRegExp(t)),t=this.createMergedBlanksRegExp(t),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(t=this.createJoinersRegExp(t)),"disabled"!==this.opt.wildcards&&(t=this.createWildcardsRegExp(t)),e?this.createAccuracyRegExp(t,!0):(t=this.createAccuracyRegExp(t,!1),new RegExp(t,"gm"+(this.opt.caseSensitive?"":"i")))}createCombinePattern(t,e){if(!Array.isArray(t)||!t.length)return null;const s=e?"(":"(?:",r=this.create(t[0],!0),a=r.lookbehind,o=r.lookahead;return{lookbehind:a,pattern:t.map((t=>`${s}${this.create(t,!0).pattern})`)).join("|"),lookahead:o}}sortByLength(t){return t.sort(((t,e)=>t.length===e.length?t>e?1:-1:e.length-t.length))}escapeStr(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}createSynonymsRegExp(t){const e=this.opt.synonyms,s=this.opt.caseSensitive?"":"i";for(let r in e)if(e.hasOwnProperty(r)){let a=Array.isArray(e[r])?e[r]:[e[r]];if(a.unshift(r),a=this.sortByLength(a).map((t=>("disabled"!==this.opt.wildcards&&(t=this.setupWildcardsRegExp(t)),t=this.escapeStr(t)))).filter((t=>""!==t)),a.length>1){const e=a.map((t=>this.escapeStr(t))).join("|");t=t.replace(new RegExp(`(?:${e})`,`gm${s}`),`(?:${a.join("|")})`)}}return t}setupWildcardsRegExp(t){return(t=t.replace(/(?:\\)*\?/g,(t=>"\\"===t.charAt(0)?"?":""))).replace(/(?:\\)*\*/g,(t=>"\\"===t.charAt(0)?"*":""))}createWildcardsRegExp(t){let e="withSpaces"===this.opt.wildcards;return t.replace(/\u0001/g,e?"[\\S\\s]?":"\\S?").replace(/\u0002/g,e?"[\\S\\s]*?":"\\S*")}setupIgnoreJoinersRegExp(t){return t.replace(/(\(\?:|\|)|\\?.(?=([|)]|$)|.)/g,((t,e,s)=>e||void 0!==s?t:t+"\0"))}createJoinersRegExp(t){let e=[];const s=this.opt.ignorePunctuation;return Array.isArray(s)&&s.length&&e.push(this.escapeStr(s.join(""))),this.opt.ignoreJoiners&&e.push("\\u00ad\\u200b\\u200c\\u200d"),e.length?t.split(/\u0000+/).join(`[${e.join("")}]*`):t}createDiacriticsRegExp(t){const e=this.opt.caseSensitive,s=["aàáảãạăằắẳẵặâầấẩẫậäåāą","AÀÁẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬÄÅĀĄ","cçćč","CÇĆČ","dđď","DĐĎ","eèéẻẽẹêềếểễệëěēę","EÈÉẺẼẸÊỀẾỂỄỆËĚĒĘ","iìíỉĩịîïī","IÌÍỈĨỊÎÏĪ","lł","LŁ","nñňń","NÑŇŃ","oòóỏõọôồốổỗộơởỡớờợöøō","OÒÓỎÕỌÔỒỐỔỖỘƠỞỠỚỜỢÖØŌ","rř","RŘ","sšśșş","SŠŚȘŞ","tťțţ","TŤȚŢ","uùúủũụưừứửữựûüůū","UÙÚỦŨỤƯỪỨỬỮỰÛÜŮŪ","yýỳỷỹỵÿ","YÝỲỶỸỴŸ","zžżź","ZŽŻŹ"];return t.split("").map((t=>{for(let r=0;r<s.length;r+=2)if(e){if(-1!==s[r].indexOf(t))return"["+s[r]+"]";if(-1!==s[r+1].indexOf(t))return"["+s[r+1]+"]"}else if(-1!==s[r].indexOf(t)||-1!==s[r+1].indexOf(t))return"["+s[r]+s[r+1]+"]";return t})).join("")}createMergedBlanksRegExp(t){return t.replace(/\s+/g,"[\\s]+")}createAccuracyRegExp(t,e){let s=this.opt.accuracy,r="string"==typeof s?s:s.value,a="string"==typeof s?[]:s.limiters,o="";a.forEach((t=>{o+=`|${this.escapeStr(t)}`}));let i,n="()",h="";switch(r){case"partially":default:i=t;break;case"complementary":o="\\s"+(o||this.escapeStr("!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~¡¿")),i=`[^${o}]*${t}[^${o}]*`;break;case"exactly":n=`(^|\\s${o})`,i=t,h=`(?=$|\\s${o})`}return e?{lookbehind:n,pattern:i,lookahead:h}:`${n}(${i})${h}`}}class s{constructor(t){this.version="2.0.0",this.ctx=t,this.cacheDict={}}set opt(t){this._opt=Object.assign({},{element:"",className:"",exclude:[],iframes:!1,iframesTimeout:5e3,separateWordSearch:!0,acrossElements:!1,ignoreGroups:0,each:()=>{},noMatch:()=>{},filter:()=>!0,done:()=>{},debug:!1,log:window.console},t)}get opt(){return this._opt}get iterator(){return new t(this.ctx,this.opt)}log(t,e="debug"){const s=this.opt.log;this.opt.debug&&"object"==typeof s&&"function"==typeof s[e]&&s[e](`mark.js: ${t}`)}checkOption(t){t&&t.acrossElements&&t.cacheTextNodes&&!t.wrapAllRanges&&(t=Object.assign({},t,{wrapAllRanges:!0}));let e=!0;return t&&t.cacheTextNodes&&this.cacheDict.type&&(t.acrossElements?"across"===this.cacheDict.type&&(e=!1):"every"===this.cacheDict.type&&(e=!1)),e&&(this.cacheDict={}),t}getSeparatedKeywords(t){let e=[];return t.forEach((t=>{this.opt.separateWordSearch?t.split(" ").forEach((t=>{t.trim()&&-1===e.indexOf(t)&&e.push(t)})):t.trim()&&-1===e.indexOf(t)&&e.push(t)})),{keywords:e.sort(((t,e)=>e.length-t.length)),length:e.length}}isNumeric(t){return Number(parseFloat(t))==t}checkRanges(t){if(!Array.isArray(t)||"[object Object]"!==Object.prototype.toString.call(t[0]))return this.log("markRanges() will only accept an array of objects"),this.opt.noMatch(t),[];const e=[];let s=0;return t.sort(((t,e)=>t.start-e.start)).forEach((t=>{let{start:r,end:a,valid:o}=this.callNoMatchOnInvalidRanges(t,s);o&&(t.start=r,t.length=a-r,e.push(t),this.opt.wrapAllRanges||(s=a))})),e}callNoMatchOnInvalidRanges(t,e){let s,r,a=!1;return t&&void 0!==t.start?(s=parseInt(t.start,10),r=s+parseInt(t.length,10),this.isNumeric(t.start)&&this.isNumeric(t.length)&&s>=e&&r>s?a=!0:(this.log(`Ignoring invalid or overlapping range: ${JSON.stringify(t)}`),this.opt.noMatch(t))):(this.log(`Ignoring invalid range: ${JSON.stringify(t)}`),this.opt.noMatch(t)),{start:s,end:r,valid:a}}checkWhitespaceRanges(t,e,s){let r,a=!0,o=s.length,i=e-o,n=parseInt(t.start,10)-i;return n=n>o?o:n,r=n+parseInt(t.length,10),r>o&&(r=o,this.log(`End range automatically set to the max value of ${o}`)),n<0||r-n<=0?(a=!1,this.log(`Invalid range: ${JSON.stringify(t)}`),this.opt.noMatch(t)):/\S/.test(s.substring(n,r))||(a=!1,this.log("Skipping whitespace only range: "+JSON.stringify(t)),this.opt.noMatch(t)),{start:n,end:r,valid:a}}checkParents(t,e){if(t===t.parentNode.lastChild){if(e(t.parentNode))return!0;{let s=t.parentNode;for(;s.parentNode&&s===s.parentNode.lastChild;){if(e(s.parentNode))return!0;s=s.parentNode}}let s=t.parentNode.nextSibling;if(s){if(1!==s.nodeType)return!0;if(e(s))return!0}}return!1}checkNextSiblings(t,e){if(t&&1===t.nodeType){if(e(t))return;if(t.firstChild){let s,r=t.firstChild;for(;r;){if(1!==r.nodeType)return;if(e(r))return;s=r,r=r.firstChild}this.checkNextSiblings(s.nextSibling,e)}t!==t.parentNode.lastChild?this.checkNextSiblings(t.nextSibling,e):e(t.parentNode)}}setType(t){const e=this.opt.blockElementsBoundary,s=Array.isArray(e.tagNames)&&e.tagNames.length;if(s&&e.tagNames.map((t=>t.toLowerCase())).forEach((e=>{t[e]=2})),!s||e.extend)for(const e in t)t[e]=2;t.br=1}getTextNodesAcrossElements(t){if(this.opt.cacheTextNodes&&this.cacheDict.nodes)return this.cacheDict.lastIndex=0,this.cacheDict.lastTextIndex=0,void t(this.cacheDict);let e,s,r,a,o,i,n="",h=0,c=" ";const l=[],d=this.opt.blockElementsBoundary,p={div:1,p:1,li:1,td:1,tr:1,th:1,ul:1,ol:1,br:1,dd:1,dl:1,dt:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,blockquote:1,figcaption:1,figure:1,pre:1,table:1,thead:1,tbody:1,tfoot:1,input:1,img:1,nav:1,details:1,label:1,form:1,select:1,menu:1,menuitem:1,main:1,section:1,article:1,aside:1,picture:1,output:1,button:1,header:1,footer:1,address:1,area:1,canvas:1,map:1,fieldset:1,textarea:1,track:1,video:1,audio:1,body:1,iframe:1,meter:1,object:1,svg:1};d&&(this.setType(p),d.char&&(c=d.char.charAt(0)+" "),i=" "+c),this.iterator.forEachNode(NodeFilter.SHOW_TEXT,(t=>{if(o=0,e=n.length,s=t.textContent,r=/\s/.test(s[s.length-1]),d||!r){this.checkParents(t,(t=>(a=p[t.nodeName.toLowerCase()],a)))||this.checkNextSiblings(t.nextSibling,(t=>(a=p[t.nodeName.toLowerCase()],a))),a&&(r?2===a&&(n+=s+c,o=2):1===a?(n+=s+" ",o=1):2===a&&(n+=s+i,o=3))}0===o&&(n+=s),l.push({start:e,end:n.length-o,offset:o,startOffset:h,node:t}),h-=o}),(t=>this.matchesExclude(t.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT),(()=>{const e={value:n,nodes:l,lastIndex:0,lastTextIndex:0};this.opt.cacheTextNodes&&(this.cacheDict=e,this.cacheDict.type="across"),t(e)}))}getTextNodes(t){if(this.opt.cacheTextNodes&&this.cacheDict.nodes)return void t(this.cacheDict);let e="",s=[];this.iterator.forEachNode(NodeFilter.SHOW_TEXT,(t=>{s.push({start:e.length,end:(e+=t.textContent).length,offset:0,node:t})}),(t=>this.matchesExclude(t.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT),(()=>{const r={value:e,nodes:s,lastIndex:0,lastTextIndex:0};this.opt.cacheTextNodes&&(this.cacheDict=r,this.cacheDict.type="every"),t(r)}))}matchesExclude(e){return-1!==["script","style","title","head","html"].indexOf(e.nodeName.toLowerCase())||this.opt.exclude&&this.opt.exclude.length&&t.matches(e,this.opt.exclude)}wrapRangeInTextNode(t,e,s){const r=t.splitText(e),a=r.splitText(s-e);return this.createMarkElement(r),a}createMarkElement(t){const e=this.opt.element?this.opt.element:"mark";let s=document.createElement(e);return s.setAttribute("data-markjs","true"),this.opt.className&&s.setAttribute("class",this.opt.className),s.textContent=t.textContent,t.parentNode.replaceChild(s,t),s}wrapRangeInTextNodeInsert(t,e,s,r,a,o){let i=r===e.node.textContent.length;if(0===s&&i){let t=this.createMarkElement(e.node);return e.node=t.childNodes[0],{retNode:e,markNode:t,increment:0}}let n=e.node.splitText(s),h=n.splitText(r-s),c=this.createMarkElement(n),l=1,d={start:a,end:e.start+r,offset:0,node:c.childNodes[0]},p={start:e.start+r,end:e.end,offset:e.offset,node:h};return 0===s?t.nodes.splice(o,1,d,p):(i?t.nodes.splice(o+1,0,d):(t.nodes.splice(o+1,0,d,p),l=2),e.end=a,e.offset=0),{retNode:p,markNode:c,increment:l}}wrapRangeInMappedTextNode(t,e,s,r,a){let o=t.lastIndex,i=!0;if(this.opt.wrapAllRanges)for(;o>=0&&t.nodes[o].start>e;)o--;else if(e<t.lastTextIndex)return;for(;o<t.nodes.length;o++)if(o+1===t.nodes.length||t.nodes[o+1].start>e){let n=t.nodes[o];if(!r(n)){o>t.lastIndex&&(t.lastIndex=o);break}const h=e-n.start,c=(s>n.end?n.end:s)-n.start;if(h>=0&&c>h){if(this.opt.wrapAllRanges){let s=this.wrapRangeInTextNodeInsert(t,n,h,c,e,o);n=s.retNode,a(s.markNode,i)}else n.node=this.wrapRangeInTextNode(n.node,h,c),n.start+=c,t.lastTextIndex=n.start,a(n.node.previousSibling,i);i=!1}if(!(s>n.end)){t.lastIndex=o;break}e=n.end+n.offset}}wrapGroups(t,e,s,r){return r((t=this.wrapRangeInTextNode(t,e,e+s)).previousSibling),t}separateGroupsD(t,e,s,r,a){let o,i,n=0,h=0,c=0,l=!1,d=0;for(;++c<e.length;)o=e[c],o&&(i=e.indices[c][0],i>=n&&(d=e.indices[c][1],r(o,t,c)&&(t=this.wrapGroups(t,i-h,d-i,(t=>{a(t,c)})),d>n&&(n=d),h=d,l=!0)));return l?s.regex.lastIndex=0:0===e[0].length&&this.setLastIndex(s.regex,d),t}separateGroups(t,e,s,r,a){let o,i,n,h=e.index,c=-1,l=!1;for(;++c<s.groups.length;)o=s.groups[c],i=e[o],i&&(n=t.textContent.indexOf(i,h),-1!==n&&(r(i,t,o)?(t=this.wrapGroups(t,n,i.length,(t=>{a(t,o)})),h=0,l=!0):h=n+i.length));return l&&(s.regex.lastIndex=0),t}wrapMatchGroupsD(t,e,s,r,a){let o,i,n,h=0,c=0,l=0;for(;++c<e.length;)o=e[c],o&&(i=e.indices[c][0],(this.opt.wrapAllRanges||i>=h)&&(l=e.indices[c][1],n=!1,this.wrapRangeInMappedTextNode(t,i,l,(t=>r(o,t.node,c)),((t,e)=>{n=!0,a(t,e,c)})),n&&l>h&&(h=l)));0===e[0].length&&this.setLastIndex(s.regex,l)}setLastIndex(t,e){e>t.lastIndex?t.lastIndex=e:e>0?t.lastIndex++:t.lastIndex=1/0}wrapMatchGroups(t,e,s,r,a){let o,i,n,h=0,c=0;const l=e.index,d=e[0];this.opt.wrapAllRanges&&this.wrapRangeInMappedTextNode(t,l,l+d.length,(t=>r(d,t.node,c)),((t,e)=>{a(t,e,c)}));for(let p=0;p<s.groups.length;p++)c=s.groups[p],o=e[c],o&&(i=d.indexOf(o,h),n=i+o.length,-1!==i&&(this.wrapRangeInMappedTextNode(t,l+i,l+n,(t=>r(o,t.node,c)),((t,e)=>{a(t,e,c)})),h=n))}collectRegexGroupIndexes(t){let e=[],s=[],r=-1,a=1,o=0,i=!1,n=t.source,h=/^\(\?<(?![=!])|^\((?!\?)/;for(;++r<n.length;)switch(n[r]){case"(":i||(h.test(n.substring(r))?(s.push(1),0===o&&e.push(a),o++,a++):s.push(0));break;case")":i||1!==s.pop()||o--;break;case"\\":r++;break;case"[":i=!0;break;case"]":i=!1}return e}wrapSeparateGroups(t,e,s,r,a){const o=t.hasIndices?"separateGroupsD":"separateGroups",i={regex:t,groups:t.hasIndices?{}:this.collectRegexGroupIndexes(t)},n={abort:!1},h={execution:n};let c,l,d,p,u=0;this.getTextNodes((e=>{e.nodes.every((e=>{for(c=e.node,h.offset=e.start;null!==(l=t.exec(c.textContent))&&(t.hasIndices||""!==l[0])&&(h.match=l,d=p=!0,c=this[o](c,l,i,((t,e,r)=>(h.matchStart=d,h.groupIndex=r,d=!1,s(t,e,h))),((t,e)=>{p&&u++,r(t,{match:l,matchStart:p,count:u,groupIndex:e}),p=!1})),!n.abort););return!n.abort})),a(u)}))}wrapMatches(t,e,s,r,a){const o=0===e?0:e+1,i={abort:!1},n={execution:i};let h,c,l,d=0;this.getTextNodes((e=>{for(let a=0;a<e.nodes.length;a++){for(h=e.nodes[a],c=h.node;null!==(l=t.exec(c.textContent))&&""!==l[o];){if(n.match=l,n.offset=h.start,!s(l[o],c,n))continue;let p=l[o].length,u=l.index;if(0!==o)for(let t=1;t<o;t++)u+=l[t].length;if(this.opt.cacheTextNodes){const s=this.wrapRangeInTextNodeInsert(e,h,u,u+p,h.start+u,a);if(d++,r(s.markNode,{match:l,count:d}),0===s.increment){t.lastIndex=0;break}a+=s.increment,h=s.retNode,c=h.node}else c=this.wrapGroups(c,u,p,(t=>{d++,r(t,{match:l,count:d})}));if(t.lastIndex=0,i.abort)break}if(i.abort)break}a(d)}))}wrapGroupsAcrossElements(t,e,s,r,a){const o=t.hasIndices?"wrapMatchGroupsD":"wrapMatchGroups",i={regex:t,groups:t.hasIndices?{}:this.collectRegexGroupIndexes(t)},n={abort:!1},h={execution:n};let c,l,d,p=0;this.getTextNodesAcrossElements((e=>{for(;null!==(c=t.exec(e.value))&&(t.hasIndices||""!==c[0])&&(h.match=c,l=d=!0,this[o](e,c,i,((t,e,r)=>(h.matchStart=l,h.groupIndex=r,l=!1,s(t,e,h))),((t,e,s)=>{d&&p++,r(t,{match:c,matchStart:d,count:p,groupIndex:s,groupStart:e}),d=!1})),!n.abort););a(p)}))}wrapMatchesAcrossElements(t,e,s,r,a){const o=0===e?0:e+1,i={abort:!1},n={execution:i};let h,c,l=0;this.getTextNodesAcrossElements((e=>{for(;null!==(h=t.exec(e.value))&&""!==h[o];){n.match=h,c=!0;let t=h.index;if(0!==o)for(let e=1;e<o;e++)t+=h[e].length;const a=t+h[o].length;if(this.wrapRangeInMappedTextNode(e,t,a,(t=>(n.matchStart=c,n.offset=t.startOffset,c=!1,s(h[o],t.node,n))),((t,e)=>{e&&l++,r(t,{match:h,matchStart:e,count:l})})),i.abort)break}a(l)}))}wrapRangeFromIndex(t,e,s,r){let a=0;this.getTextNodes((o=>{const i=o.value.length;t.forEach(((t,r)=>{let{start:n,end:h,valid:c}=this.checkWhitespaceRanges(t,i,o.value);c&&this.wrapRangeInMappedTextNode(o,n,h,(s=>e(s.node,t,o.value.substring(n,h),r)),((e,r)=>{r&&a++,s(e,t,{matchStart:r,count:a})}))})),r(a)}))}unwrapMatches(t){const e=t.parentNode,s=t.firstChild;if(1===t.childNodes.length)if(3===s.nodeType){const r=t.previousSibling,a=t.nextSibling;if(r&&3===r.nodeType)a&&3===a.nodeType?(r.nodeValue+=s.nodeValue+a.nodeValue,e.removeChild(a)):r.nodeValue+=s.nodeValue;else{if(!a||3!==a.nodeType)return void e.replaceChild(t.firstChild,t);a.nodeValue=s.nodeValue+a.nodeValue}e.removeChild(t)}else e.replaceChild(t.firstChild,t);else{if(s){let s=document.createDocumentFragment();for(;t.firstChild;)s.appendChild(t.removeChild(t.firstChild));e.replaceChild(s,t)}else e.removeChild(t);e.normalize()}}markRegExp(t,e){this.opt=this.checkOption(e);let s=0,r=this.opt.separateGroups?"wrapSeparateGroups":"wrapMatches";if(this.opt.acrossElements&&(r=this.opt.separateGroups?"wrapGroupsAcrossElements":"wrapMatchesAcrossElements"),this.opt.acrossElements&&!t.global&&!t.sticky){let e=t.toString().split("/");t=new RegExp(t.source,"g"+e[e.length-1]),this.log("RegExp was recompiled because it must have g flag")}this.log(`Searching with expression "${t}"`),this[r](t,this.opt.ignoreGroups,((t,e,r)=>this.opt.filter(e,t,s,r)),((t,e)=>{s++,this.opt.each(t,e)}),(e=>{0===e&&this.opt.noMatch(t),this.opt.done(s,e)}))}mark(t,s){if(s&&s.combinePatterns)return void this.markCombinePatterns(t,s);this.opt=this.checkOption(s);let r=0,a=0,o=0;const i=this.opt.acrossElements?"wrapMatchesAcrossElements":"wrapMatches",n={},{keywords:h,length:c}=this.getSeparatedKeywords("string"==typeof t?[t]:t),l=t=>{const s=new e(this.opt).create(t);let d=0;this.log(`Searching with expression "${s}"`),this[i](s,1,((e,s,r)=>this.opt.filter(s,t,a,d,r)),((t,e)=>{d++,a++,this.opt.each(t,e)}),(e=>{o+=e,0===e&&this.opt.noMatch(t),n[t]=e,++r<c?l(h[r]):this.opt.done(a,o,n)}))};0===c?this.opt.done(0,0,n):l(h[r])}markCombinePatterns(t,e){this.opt=this.checkOption(e);let s,r=0,a=0,o=0,i=[],n=[];const h=this.opt.acrossElements,c=h?"wrapMatchesAcrossElements":"wrapMatches",l="gm"+(this.opt.caseSensitive?"":"i"),d={},p=this.getSeparatedKeywords("string"==typeof t?[t]:t),u=t=>{const e=new RegExp(t,l),p=n[r];this.log(`Searching with expression "${e}"`),this[c](e,1,((t,e,r)=>(h?r.matchStart&&(s=this.getCurrentTerm(r.match,p)):s=this.getCurrentTerm(r.match,p),this.opt.filter(e,s,a,d[s],r))),((t,e)=>{a++,h?e.matchStart&&(d[s]+=1):d[s]+=1,this.opt.each(t,e)}),(t=>{o+=t;const e=p.filter((t=>0===d[t]));e.length&&this.opt.noMatch(e),++r<i.length?u(i[r]):this.opt.done(a,o,d)}))};if(0===p.length)this.opt.done(0,0,d);else{p.keywords.forEach((t=>{d[t]=0}));const t=this.getPatterns(p.keywords);n=t.terms,i=t.patterns,u(i[r])}}getCurrentTerm(t,e){let s=t.length;for(;--s>2;)if(t[s])return e[s-3];return" "}getPatterns(t){const s=new e(this.opt),r=s.create(t[0],!0),a=[],o=[];let i=10;"number"==typeof this.opt.combinePatterns&&(this.opt.combinePatterns===1/0?i=Math.pow(2,31):this.isNumeric(this.opt.combinePatterns)&&(i=parseInt(this.opt.combinePatterns)));let n=Math.ceil(t.length/i);for(let e=0;e<n;e++){let n=r.lookbehind+"(";const h=[],c=Math.min(e*i+i,t.length);for(let s=e*i;s<c;s++)h.push(t[s]);n+=s.createCombinePattern(h,!0).pattern,a.push(n+")"+r.lookahead),o.push(h)}return{patterns:a,terms:o}}markRanges(t,e){this.opt=e,this.cacheDict={};let s=0,r=this.checkRanges(t);r&&r.length?(this.log("Starting to mark with the following ranges: "+JSON.stringify(r)),this.wrapRangeFromIndex(r,((t,e,s,r)=>this.opt.filter(t,e,s,r)),((t,e,r)=>{s++,this.opt.each(t,e,r)}),(t=>{this.opt.done(s,t)}))):this.opt.done(0,0)}unmark(e){this.opt=e,this.cacheDict={};let s=(this.opt.element?this.opt.element:"mark")+"[data-markjs]";this.opt.className&&(s+=`.${this.opt.className}`),this.log(`Removal selector "${s}"`),this.iterator.forEachNode(NodeFilter.SHOW_ELEMENT,(t=>{this.unwrapMatches(t)}),(e=>t.matches(e,s)&&!this.matchesExclude(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT),this.opt.done)}}function r(t){const e=new s(t);return this.mark=(t,s)=>(e.mark(t,s),this),this.markRegExp=(t,s)=>(e.markRegExp(t,s),this),this.markRanges=(t,s)=>(e.markRanges(t,s),this),this.unmark=t=>(e.unmark(t),this),this.getVersion=()=>e.version,this}export{r as default};
