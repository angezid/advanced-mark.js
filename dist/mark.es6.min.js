/*!***************************************************
* advanced-mark.js v2.4.1
* https://github.com/angezid/advanced-mark.js#readme
* MIT licensed
* Copyright (c) 2022–2023, angezid
* Based on 'mark.js', license https://git.io/vwTVl
*****************************************************/
class t{constructor(t,e){this.ctx=t,this.opt=e,this.attrName="data-markjsListener"}static matches(t,e){if(!e||!e.length)return!1;const s="string"==typeof e?[e]:e,r=t.matches||t.matchesSelector||t.msMatchesSelector||t.mozMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector;return r&&s.some((e=>r.call(t,e)))}getContexts(){let t=this.ctx,e=!1;if(!t)return[];this.opt.window.NodeList.prototype.isPrototypeOf(t)||(Array.isArray(t)?e=!0:t="string"==typeof t?this.opt.window.document.querySelectorAll(t):[t]);const s=[];return t.forEach((t=>{-1!==s.indexOf(t)||s.some((e=>e.contains(t)))||s.push(t)})),e&&s.sort(((t,e)=>(t.compareDocumentPosition(e)&this.opt.window.Node.DOCUMENT_POSITION_FOLLOWING)>0?-1:1)),s}getIframeContents(t,e,s){try{const s=t.contentWindow.document;s&&(t.setAttribute(this.attrName,"completed"),e({iframe:t,context:s}))}catch(e){t.setAttribute(this.attrName,"error"),s({iframe:t,error:e})}}isIframeBlank(t){const e="about:blank",s=t.getAttribute("src").trim();return t.contentWindow.location.href===e&&s!==e&&s}observeIframeLoad(t,e,s){if(t.hasAttribute(this.attrName))return;let r=null;const o=()=>{clearTimeout(r),t.removeEventListener("load",o),this.getIframeContents(t,e,s)};t.addEventListener("load",o),t.setAttribute(this.attrName,!0),r=setTimeout(o,this.opt.iframesTimeout)}onIframeReady(t,e,s){try{"complete"===t.contentWindow.document.readyState?this.isIframeBlank(t)?this.observeIframeLoad(t,e,s):this.getIframeContents(t,e,s):this.observeIframeLoad(t,e,s)}catch(t){s(t)}}waitForAllIframes(e,s){let r=0,o=[],n=[],i=!1;const a=setTimeout((()=>{i=!0,s()}),this.opt.iframesTimeout),c=()=>{clearTimeout(a),i||s()},h=()=>{r===o.filter((t=>!this.hasAttributeValue(t,this.attrName,"error"))).length&&c()},l=e=>{e.iframe&&"about:blank"===e.context.location.href||(n=[],e.context.querySelectorAll(e.iframe?"body iframe":"iframe").forEach((e=>{t.matches(e,this.opt.exclude)||(o.push(e),e.hasAttribute(this.attrName)||n.push(e))})),e.iframe||n.length)?n.length?n.forEach((t=>{this.onIframeReady(t,(t=>{r++,l(t)}),(t=>{this.opt.debug&&console.log(t.error),h()}))})):h():c()};l({context:e})}createIterator(t,e,s){return this.opt.window.document.createNodeIterator(t,e,s,!1)}addRemoveStyle(t,e,s){if(s){if(e&&t.firstChild&&!t.querySelector("style[data-markjs]")){const s=this.opt.window.document.createElement("style");s.setAttribute("data-markjs","true"),s.textContent=e,t.insertBefore(s,t.firstChild)}}else{let e=t.querySelector("style[data-markjs]");e&&t.removeChild(e)}}hasAttributeValue(t,e,s){return t.hasAttribute(e)&&t.getAttribute(e)===s}iterateThroughNodes(e,s,r,o,n){const i=this.opt.window.NodeFilter,a=this.opt.shadowDOM,c=this.opt.iframes;if(c||a){const n=0!=(s&i.SHOW_ELEMENT),h=0!=(s&i.SHOW_TEXT);h&&(s=i.SHOW_ELEMENT|i.SHOW_TEXT);const l=e=>{const i=this.createIterator(e,s);for(;e=i.nextNode();)1===e.nodeType?(n&&r(e)&&o(e),c&&"iframe"===e.nodeName.toLowerCase()&&!t.matches(e,this.opt.exclude)&&this.hasAttributeValue(e,this.attrName,"completed")&&this.getIframeContents(e,(t=>{l(t.context)}),(()=>{})),a&&e.shadowRoot&&"open"===e.shadowRoot.mode&&(this.addRemoveStyle(e.shadowRoot,a.style,h),l(e.shadowRoot))):h&&3===e.nodeType&&r(e)&&o(e)};l(e)}else{const t=this.createIterator(e,s,(t=>r(t)?i.FILTER_ACCEPT:i.FILTER_REJECT));let n;for(;n=t.nextNode();)o(n)}n()}forEachNode(t,e,s,r=(()=>{})){const o=this.getContexts();let n=o.length;n||r(),o.forEach((o=>{n--;const i=()=>{this.iterateThroughNodes(o,t,s,e,(()=>{n<=0&&r()}))};this.opt.iframes?this.waitForAllIframes(o,i):i()}))}}class e{constructor(t){this.opt=Object.assign({},{diacritics:!0,synonyms:{},accuracy:"partially",caseSensitive:!1,ignoreJoiners:!1,ignorePunctuation:[],wildcards:"disabled"},t)}get chars(){return this._chars||(this._chars=[],["aàáảãạăằắẳẵặâầấẩẫậäåāą","cçćč","dđď","eèéẻẽẹêềếểễệëěēę","iìíỉĩịîïī","lł","nñňń","oòóỏõọôồốổỗộơởỡớờợöøōő","rř","sšśșş","tťțţ","uùúủũụưừứửữựûüůūű","yýỳỷỹỵÿ","zžżź"].forEach((t=>{this._chars.push(t,t.toUpperCase())}))),this._chars}create(t,e){const s="g"+(this.opt.caseSensitive?"":"i");t=this.checkWildcardsEscape(t),t=this.createSynonyms(t,s);const r=this.getJoinersPunctuation();r&&(t=this.setupIgnoreJoiners(t)),this.opt.diacritics&&(t=this.createDiacritics(t)),t=t.replace(/\s+/g,"[\\s]+"),r&&(t=this.createJoiners(t,r)),"disabled"!==this.opt.wildcards&&(t=this.createWildcards(t));const o=this.createAccuracy(t);return e?o:new RegExp(`${o.lookbehind}(${o.pattern})${o.lookahead}`,s)}createCombinePattern(t,e){if(!Array.isArray(t)||!t.length)return null;const s=e?"(":"(?:",r=this.create(t[0],!0);return r.pattern=this.distinct(t.map((t=>`${s}${this.create(t,!0).pattern})`))).join("|"),r}sortByLength(t){return t.sort(((t,e)=>t.length===e.length?t>e?1:-1:e.length-t.length))}escape(t){return t.replace(/[[\]/{}()*+?.\\^$|]/g,"\\$&")}preprocess(t){return t&&t.length?this.distinct("string"==typeof t?t.split(""):t).join("").replace(/[-^\]\\]/g,"\\$&"):""}distinct(t){const e=[];return t.forEach((t=>{t.trim()&&-1===e.indexOf(t)&&e.push(t)})),e}createSynonyms(t,e){const s=this.opt.synonyms;if(!Object.keys(s).length)return t;for(const r in s)if(s.hasOwnProperty(r)){let o=Array.isArray(s[r])?s[r]:[s[r]];if(o.unshift(r),o=this.sortByLength(this.distinct(o)).map((t=>this.checkWildcardsEscape(t))),o.length>1){const s=o.map((t=>this.escape(t))).join("|");t=t.replace(new RegExp(s,e),`(?:${o.join("|")})`)}}return t}checkWildcardsEscape(t){return"disabled"!==this.opt.wildcards&&(t=t.replace(/(\\.)+|[?*]/g,((t,e)=>e?t:"?"===t?"":"")).replace(/\\+(?=[?*\x01\x02])/g,(t=>t.slice(1)))),this.escape(t)}createWildcards(t){const e="withSpaces"===this.opt.wildcards,s=this.opt.blockElementsBoundary,r=`[^${e&&s?"":""}]*?`;return t.replace(/\x01/g,e?"[^]?":"\\S?").replace(/\x02/g,e?r:"\\S*")}setupIgnoreJoiners(t){return t.replace(/((?:\\\\)+|\x02|\(\?:|\|)|\\?(?:[\uD800-\uDBFF][\uDC00-\uDFFF]|.)(?=([|)\x02]|$)|.)/g,((t,e,s)=>e||void 0!==s?t:t+"\0"))}createJoiners(t,e){return t.split(/\x00+/).join(`[${e}]*`)}getJoinersPunctuation(){let t=this.preprocess(this.opt.ignorePunctuation),e=t||"";return this.opt.ignoreJoiners&&(e+="\\u00ad\\u200b\\u200c\\u200d"),e}createDiacritics(t){const e=this.chars;return t.split("").map((t=>{for(let s=0;s<e.length;s+=2){const r=-1!==e[s].indexOf(t);if(this.opt.caseSensitive){if(r)return"["+e[s]+"]";if(-1!==e[s+1].indexOf(t))return"["+e[s+1]+"]"}else if(r||-1!==e[s+1].indexOf(t))return"["+e[s]+e[s+1]+"]"}return t})).join("")}createAccuracy(t){let e,s=this.opt.accuracy,r="()",o=t,n="";if("string"!=typeof s&&(e=this.preprocess(s.limiters),s=s.value),"exactly"===s){const t=e?"[\\s"+e+"]":"\\s";r=`(^|${t})`,n=`(?=$|${t})`}else{const n=e||"!\"#$%&'()*+,\\-./:;<=>?@[\\]\\\\^_`{|}~¡¿",i=`[^\\s${n}]*`;"complementary"===s?o=i+t+i:"startsWith"===s&&(r=`(^|[\\s${n}])`,o=t.replace(/\[\\s\]\+/g,i+"$&")+i)}return{lookbehind:r,pattern:o,lookahead:n}}}class s{constructor(t){this.ctx=t,this.nodeNames=["script","style","title","head","html"]}set opt(t){if(!(t&&t.window&&t.window.document)&&"undefined"==typeof window)throw new Error("Mark.js: please provide a window object as an option.");const e=t&&t.window||window;this._opt=Object.assign({},{window:e,element:"",className:"",exclude:[],iframes:!1,iframesTimeout:5e3,separateWordSearch:!0,acrossElements:!1,ignoreGroups:0,each:()=>{},noMatch:()=>{},filter:()=>!0,done:()=>{},debug:!1,log:e.console},t),this._opt.element||(this._opt.element="mark")}get opt(){return this._opt}get empty(){return this._empty||(this._empty=this.opt.window.document.createTextNode("")),this._empty}get iterator(){return new t(this.ctx,this.opt)}log(t,e="debug"){if(this.opt.debug){const s=this.opt.log;"object"==typeof s&&"function"==typeof s[e]&&s[e](`mark.js: ${t}`)}}report(t){t.forEach((t=>{this.log(`${t.text} ${JSON.stringify(t.obj)}`,t.level||"debug"),t.skip||this.opt.noMatch(t.obj)}))}checkOption(t,e){this.opt=t;let s=this.cacheDict,r=!0;s&&(!e&&this.opt.cacheTextNodes&&(this.opt.acrossElements?s.across&&(r=!1):s.across||(r=!1)),r&&(this.cacheDict=null))}getSeachTerms(t){const e="string"==typeof t?[t]:t,s=this.opt.separateWordSearch,r=[],o={},n=t=>{t.split(/ +/).forEach((t=>i(t)))},i=t=>{t.trim()&&-1===r.indexOf(t)&&(r.push(t),o[t]=0)};return e.forEach((t=>{s?"preserveTerms"===s?t.split(/"("*[^"]+"*)"/).forEach(((t,e)=>{e%2>0?i(t):n(t)})):n(t):i(t)})),r.sort(((t,e)=>e.length-t.length)),{terms:r,termStats:o}}isNumeric(t){return Number(parseFloat(t))==t}checkRanges(t,e,s,r){const o="error",n=t.filter((t=>!!(this.isNumeric(t.start)&&this.isNumeric(t.length)&&(t.start=parseInt(t.start),t.length=parseInt(t.length),t.start>=s&&t.start<r&&t.length>0))||(e.push({text:"Invalid range: ",obj:t,level:o}),!1))).sort(((t,e)=>t.start-e.start));if(this.opt.wrapAllRanges)return n;let i,a=0;return n.filter((t=>(i=t.start+t.length,t.start>=a?(a=i,!0):(e.push({text:(i<a?"Nest":"Overlapp")+"ing range: ",obj:t,level:o}),!1))))}setType(t,e){const s=Array.isArray(e.tagNames)&&e.tagNames.length;if(s&&e.tagNames.forEach((e=>t[e.toLowerCase()]=2)),!s||e.extend)for(const e in t)t[e]=2;t.br=3}getTextNodesAcross(t){if(this.opt.cacheTextNodes&&this.cacheDict)return this.cacheDict.lastIndex=0,this.cacheDict.lastTextIndex=0,void t(this.cacheDict);const e={div:1,p:1,li:1,td:1,tr:1,th:1,ul:1,ol:1,dd:1,dl:1,dt:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,blockquote:1,figcaption:1,figure:1,pre:1,table:1,thead:1,tbody:1,tfoot:1,input:1,img:1,nav:1,details:1,label:1,form:1,select:1,menu:1,br:3,menuitem:1,main:1,section:1,article:1,aside:1,picture:1,output:1,button:1,header:1,footer:1,address:1,area:1,canvas:1,map:1,fieldset:1,textarea:1,track:1,video:1,audio:1,body:1,iframe:1,meter:1,object:1,svg:1},s=[],r=this.opt.blockElementsBoundary,o=r?2:1;let n,i,a,c="";r&&(this.setType(e,r),r.char&&(c=r.char.charAt(0)));const h={text:"",regex:/\s/,tags:e,boundary:r,startOffset:0,str:"",ch:c};this.iterator.forEachNode(this.opt.window.NodeFilter.SHOW_ELEMENT|this.opt.window.NodeFilter.SHOW_TEXT,(t=>{a&&s.push(this.getNodeInfo(a,t,i,h)),i=null,a=t}),(t=>1===t.nodeType?(n=e[t.nodeName.toLowerCase()],3===n&&(h.str+="\n"),i&&n!==o||(i=n),!1):!this.excluded(t.parentNode)),(()=>{a&&s.push(this.getNodeInfo(a,null,i,h)),t(this.createDict(h.text,s,!0))}))}getNodeInfo(t,e,s,r){const o=r.text.length,n=r.startOffset,i=r.ch;let a=0,c=r.str,h=t.textContent;if(e){const o=r.regex.test(e.textContent[0]),n=o&&r.regex.test(h[h.length-1]);if(r.boundary||!n){let a=s;if(!s){let o=t.parentNode;for(;o;){if(s=r.tags[o.nodeName.toLowerCase()]){a=!(o===e.parentNode||o.contains(e));break}o=o.parentNode}}a&&(n?2===s&&(c+=n?i:o?" "+i:i+" "):c+=1===s?" ":2===s?" "+i+" ":"")}}return c&&(h+=c,a=c.length,r.startOffset-=a,r.str=""),r.text+=h,this.createInfo(t,o,r.text.length-a,a,n)}getTextNodes(t){if(this.opt.cacheTextNodes&&this.cacheDict)return void t(this.cacheDict);const e=[],s=/\n/g,r=[0],o=this.opt.markLines;let n,i="",a=0,c=this.opt.window.NodeFilter.SHOW_TEXT;c=o?this.opt.window.NodeFilter.SHOW_ELEMENT|c:c,this.iterator.forEachNode(c,(t=>{if(o)for(;null!==(n=s.exec(t.textContent));)r.push(a+n.index);i+=t.textContent,e.push({start:a,end:a=i.length,offset:0,node:t})}),(t=>o&&1===t.nodeType?("br"===t.tagName.toLowerCase()&&r.push(a),!1):!this.excluded(t.parentNode)),(()=>{const s=this.createDict(i,e,!1);o&&(r.push(a),s.newLines=r),t(s)}))}createDict(t,e,s){const r={text:t,nodes:e,lastIndex:0,lastTextIndex:0};return this.opt.cacheTextNodes&&(this.cacheDict=r,this.cacheDict.across=s),r}excluded(e){return-1!==this.nodeNames.indexOf(e.nodeName.toLowerCase())||t.matches(e,this.opt.exclude)}wrapRangeInsert(t,e,s,r,o,n){const i=r===e.node.textContent.length,a=e.end;let c=1,h=r,l=e.node;0!==s?(l=l.splitText(s),h=r-s,c=i?2:3):i&&(c=0);const p=i?this.empty:l.splitText(h),d=this.wrapTextNode(l),u=d.childNodes[0],g=this.createInfo(p,0===c||2===c?a:e.start+r,a,e.offset,e.startOffset);if(0===c)return e.node=u,{mark:d,nodeInfo:g,increment:0};const m=this.createInfo(u,1===c?e.start:o,e.start+r,0,e.startOffset);return 1===c?t.nodes.splice(n,1,m,g):(2===c?t.nodes.splice(n+1,0,m):t.nodes.splice(n+1,0,m,g),e.end=o,e.offset=0),{mark:d,nodeInfo:g,increment:c<3?1:2}}createInfo(t,e,s,r,o){return{node:t,start:e,end:s,offset:r,startOffset:o}}wrapRange(t,e,s,r){let o,n=s===t.textContent.length,i=s;return 0!==e&&(t=t.splitText(e),i=s-e),o=n?this.empty:t.splitText(i),r(this.wrapTextNode(t)),o}wrapTextNode(t){let e=this.opt.window.document.createElement(this.opt.element);return e.setAttribute("data-markjs","true"),this.opt.className&&e.setAttribute("class",this.opt.className),e.textContent=t.textContent,t.parentNode.replaceChild(e,t),e}wrapRangeAcross(t,e,s,r,o){let n=t.lastIndex,i=!0;const a=this.opt.wrapAllRanges||this.opt.cacheTextNodes;if(a)for(;n>0&&t.nodes[n].start>e;)n--;else if(e<t.lastTextIndex)return;for(;n<t.nodes.length;n++)if(n+1===t.nodes.length||t.nodes[n+1].start>e){let c=t.nodes[n];if(!r(c))break;const h=e-c.start,l=(s>c.end?c.end:s)-c.start;if(h>=0&&l>h){if(a){const s=this.wrapRangeInsert(t,c,h,l,e,n);c=s.nodeInfo,o(s.mark,i)}else c.node=this.wrapRange(c.node,h,l,(t=>{o(t,i)})),c.start+=l,t.lastTextIndex=c.start;i=!1}if(!(s>c.end))break;e=c.end+c.offset}t.lastIndex=n}wrapGroups(t,e,s,r,o){let n,i,a,c=e.index,h=-1,l=!1;for(;++h<s.groups.length;)n=s.groups[h],i=e[n],i&&(a=t.textContent.indexOf(i,c),-1!==a&&(r(t,i,n)?(t=this.wrapRange(t,a,a+i.length,(t=>{o(t,n)})),c=0,l=!0):c=a+i.length));return l&&(s.regex.lastIndex=0),t}wrapGroupsAcross(t,e,s,r,o){let n,i,a,c=0,h=0;const l=e.index,p=e[0],d=(e,s)=>{this.wrapRangeAcross(t,e,s,(t=>r(t,p,h)),((t,e)=>{o(t,e,h)}))};this.opt.wrapAllRanges&&d(l,l+p.length);for(let t=0;t<s.groups.length;t++)h=s.groups[t],n=e[h],n&&(i=p.indexOf(n,c),-1!==i&&(a=i+n.length,d(l+i,l+a),c=a))}wrapGroupsDFlag(t,e,s,r,o){let n,i,a=0,c=0,h=0,l=!1,p=0;for(;++h<e.length;)n=e[h],n&&(i=e.indices[h][0],i>=a&&(p=e.indices[h][1],r(t,n,h)&&(t=this.wrapRange(t,i-c,p-c,(t=>{o(t,h)})),p>a&&(a=p),c=p,l=!0)));return l?s.regex.lastIndex=0:0===e[0].length&&this.setLastIndex(s.regex,p),t}wrapGroupsDFlagAcross(t,e,s,r,o){let n,i,a,c=0,h=0,l=0;for(;++h<e.length;)n=e[h],n&&(i=e.indices[h][0],(this.opt.wrapAllRanges||i>=c)&&(l=e.indices[h][1],a=!1,this.wrapRangeAcross(t,i,l,(t=>r(t,n,h)),((t,e)=>{a=!0,o(t,e,h)})),a&&l>c&&(c=l)));0===e[0].length&&this.setLastIndex(s.regex,l)}setLastIndex(t,e){const s=t.lastIndex;t.lastIndex=e>s?e:e>0?s+1:1/0}collectGroupIndexes(t){let e,s=[],r=[],o=0,n=0,i=t.source,a=/(?:\\.)+|\[(?:[^\\\]]|(?:\\.))+\]|(\(\?<(?![=!])|\((?!\?))|(\()|(\))/g;for(;null!==(e=a.exec(i));)e[1]?(r.push(1),o++,0==n++&&s.push(o)):e[2]?r.push(0):e[3]&&r.pop()&&n--;return s}wrapSeparateGroups(t,e,s,r,o){const n=t.hasIndices,i=n?"wrapGroupsDFlag":"wrapGroups",a={regex:t,groups:n?{}:this.collectGroupIndexes(t)},c={abort:!1},h={execution:c};let l,p,d,u,g=0;this.getTextNodes((e=>{e.nodes.every((e=>{for(l=e.node,h.offset=e.start;null!==(p=t.exec(l.textContent))&&(n||""!==p[0])&&(h.match=p,d=u=!0,l=this[i](l,p,a,((t,e,r)=>(h.matchStart=d,h.groupIndex=r,d=!1,s(t,e,h))),((t,e)=>{u&&g++,r(t,{match:p,matchStart:u,count:g,groupIndex:e}),u=!1})),!c.abort););return!c.abort})),o(g)}))}wrapSeparateGroupsAcross(t,e,s,r,o){const n=t.hasIndices,i=n?"wrapGroupsDFlagAcross":"wrapGroupsAcross",a={regex:t,groups:n?{}:this.collectGroupIndexes(t)},c={abort:!1},h={execution:c};let l,p,d,u=0;this.getTextNodesAcross((e=>{for(;null!==(l=t.exec(e.text))&&(n||""!==l[0])&&(h.match=l,p=d=!0,this[i](e,l,a,((t,e,r)=>(h.matchStart=p,h.groupIndex=r,h.offset=t.startOffset,p=!1,s(t.node,e,h))),((t,e,s)=>{d&&u++,r(t,{match:l,matchStart:d,count:u,groupIndex:s,groupStart:e}),d=!1})),!c.abort););o(u)}))}wrapMatches(t,e,s,r,o){const n=0===e?0:e+1,i={abort:!1},a={execution:i};let c,h,l,p,d=0;this.getTextNodes((e=>{for(let o=0;o<e.nodes.length;o++){for(c=e.nodes[o],h=c.node;null!==(l=t.exec(h.textContent))&&""!==(p=l[n]);){if(a.match=l,a.offset=c.start,!s(h,p,a))continue;let u=0,g=l.index;for(;++u<n;)l[u]&&(g+=l[u].length);const m=g+p.length;if(this.opt.cacheTextNodes){const t=this.wrapRangeInsert(e,c,g,m,c.start+g,o);if(r(t.mark,{match:l,count:++d}),0===t.increment)break;o+=t.increment,c=t.nodeInfo,h=c.node}else h=this.wrapRange(h,g,m,(t=>{r(t,{match:l,count:++d})}));if(t.lastIndex=0,i.abort)break}if(i.abort)break}o(d)}))}wrapMatchesAcross(t,e,s,r,o){const n=0===e?0:e+1,i={abort:!1},a={execution:i};let c,h,l,p=0;this.getTextNodesAcross((e=>{for(;null!==(c=t.exec(e.text))&&""!==(h=c[n]);){a.match=c,l=!0;let t=0,o=c.index;for(;++t<n;)c[t]&&(o+=c[t].length);if(this.wrapRangeAcross(e,o,o+h.length,(t=>(a.matchStart=l,a.offset=t.startOffset,l=!1,s(t.node,h,a))),((t,e)=>{e&&p++,r(t,{match:c,matchStart:e,count:p})})),i.abort)break}o(p)}))}wrapRanges(t,e,s,r){const o=this.opt.markLines,n=[],i=[],a="warn";let c=0;this.getTextNodes((h=>{const l=o?h.newLines.length:h.text.length,p=this.checkRanges(t,n,o?1:0,l);p.forEach(((t,r)=>{let p=t.start,d=p+t.length;d>l&&(n.push({text:`Range was limited to: ${l}`,obj:t,skip:!0,level:a}),d=l),o&&(p=h.newLines[p-1],"\n"===h.text[p]&&p++,d=h.newLines[d-1]);const u=h.text.substring(p,d);u.trim()?this.wrapRangeAcross(h,p,d,(s=>e(s.node,t,u,r)),((e,r)=>{r&&c++,s(e,t,{matchStart:r,count:c})})):(n.push({text:"Skipping whitespace only range: ",obj:t,level:a}),i.push(t))})),this.log(`Valid ranges: ${JSON.stringify(p.filter((t=>-1===i.indexOf(t))))}`),r(c,n)}))}unwrapMatches(t){const e=t.parentNode,s=t.firstChild;if(1===t.childNodes.length)if(3===s.nodeType){const r=t.previousSibling,o=t.nextSibling;if(r&&3===r.nodeType)o&&3===o.nodeType?(r.nodeValue+=s.nodeValue+o.nodeValue,e.removeChild(o)):r.nodeValue+=s.nodeValue;else{if(!o||3!==o.nodeType)return void e.replaceChild(t.firstChild,t);o.nodeValue=s.nodeValue+o.nodeValue}e.removeChild(t)}else e.replaceChild(t.firstChild,t);else{if(s){let s=this.opt.window.document.createDocumentFragment();for(;t.firstChild;)s.appendChild(t.removeChild(t.firstChild));e.replaceChild(s,t)}else e.removeChild(t);e.normalize()}}markRegExp(t,e){this.checkOption(e);let s=0,r=0,o=this.opt.separateGroups?"wrapSeparateGroups":"wrapMatches";if(this.opt.acrossElements&&(o+="Across",!t.global&&!t.sticky)){let e=t.toString().split("/");t=new RegExp(t.source,"g"+e[e.length-1]),this.log("RegExp is recompiled because it must have g flag")}this.log(`RegExp "${t}"`),this[o](t,this.opt.ignoreGroups,((t,e,s)=>this.opt.filter(t,e,r,s)),((t,e)=>{r=e.count,s++,this.opt.each(t,e)}),(e=>{0===e&&this.opt.noMatch(t),this.opt.done(s,e)}))}mark(t,s){this.checkOption(s);const{terms:r,termStats:o}=this.getSeachTerms(t);if(!r.length)return void this.opt.done(0,0,o);if(this.opt.combinePatterns)return void this.markCombinePatterns(r,o);let n,i=0,a=0,c=0,h=0;const l=new e(this.opt),p=this.opt.acrossElements?"wrapMatchesAcross":"wrapMatches",d=t=>{n=0;const e=l.create(t);this.log(`RegExp "${e}"`),this[p](e,1,((e,s,r)=>(c=h+n,this.opt.filter(e,t,c,n,r))),((t,e)=>{n=e.count,a++,this.opt.each(t,e)}),(e=>{h+=e,0===e&&this.opt.noMatch(t),o[t]=e,++i<r.length?d(r[i]):this.opt.done(a,h,o)}))};d(r[i])}markCombinePatterns(t,e){let s,r,o=0,n=0,i=0;const a=this.opt.acrossElements,c=a?"wrapMatchesAcross":"wrapMatches",h="g"+(this.opt.caseSensitive?"":"i"),l=this.getPatterns(t),p=({pattern:t,regTerms:d})=>{const u=new RegExp(t,h);this.log(`RegExp "${u}"`),this[c](u,1,((t,o,n)=>(a&&!n.matchStart||(s=this.getCurrentTerm(n.match,d)),r=e[s],this.opt.filter(t,s,i+r,r,n))),((t,r)=>{n++,a&&!r.matchStart||(e[s]+=1),this.opt.each(t,r)}),(t=>{i+=t;const s=d.filter((t=>0===e[t]));s.length&&this.opt.noMatch(s),++o<l.length?p(l[o]):this.opt.done(n,i,e)}))};p(l[o])}getCurrentTerm(t,e){let s=t.length;for(;--s>2;)if(t[s])return e[s-3];return" "}getPatterns(t){const s=new e(this.opt),r=this.opt.combinePatterns,o=[];let n,i=10;r===1/0?i=Math.pow(2,31):Number.isInteger(r)&&(n=parseInt(r))>0&&(i=n);const a=Math.ceil(t.length/i);for(let e=0;e<a;e++){const r=e*i,n=t.slice(r,Math.min(r+i,t.length)),a=s.createCombinePattern(n,!0);o.push({pattern:`${a.lookbehind}(${a.pattern})${a.lookahead}`,regTerms:n})}return o}markRanges(t,e){if(this.checkOption(e,!0),Array.isArray(t)&&t.some((t=>"[object Object]"===String(t)))){let e=0;this.wrapRanges(t,((t,e,s,r)=>this.opt.filter(t,e,s,r)),((t,s,r)=>{e++,this.opt.each(t,s,r)}),((t,s)=>{this.report(s),this.opt.done(e,t)}))}else this.report([{text:"markRanges() accept an array of objects: ",obj:t,level:"error"}]),this.opt.done(0,0)}unmark(e){this.checkOption(e,!0);let s=this.opt.element+"[data-markjs]";this.opt.className&&(s+=`.${this.opt.className}`),this.log(`Removal selector "${s}"`),this.iterator.forEachNode(this.opt.window.NodeFilter.SHOW_ELEMENT,(t=>{this.unwrapMatches(t)}),(e=>t.matches(e,s)&&!this.excluded(e)),this.opt.done)}}function r(t){const e=new s(t);return this.mark=(t,s)=>(e.mark(t,s),this),this.markRegExp=(t,s)=>(e.markRegExp(t,s),this),this.markRanges=(t,s)=>(e.markRanges(t,s),this),this.unmark=t=>(e.unmark(t),this),this.getVersion=()=>"2.4.1",this}export{r as default};
