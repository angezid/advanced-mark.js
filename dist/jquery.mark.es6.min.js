/*!***************************************************
* mark.js v10.0.0
* https://markjs.io/
* Copyright (c) 2014–2022, Julian Kühnel
* Released under the MIT license https://git.io/vwTVl
*****************************************************/
import"./jquery.js";class DOMIterator{constructor(e,t=!0,r=[],s=5e3,o=!1){this.ctx=e,this.iframes=t,this.exclude=r,this.iframesTimeout=s,this.shadowDOM=o}static matches(e,t){const r="string"==typeof t?[t]:t;if(!r)return!1;const s=e.matches||e.matchesSelector||e.msMatchesSelector||e.mozMatchesSelector||e.oMatchesSelector||e.webkitMatchesSelector;if(s){let t=!1;return r.every(r=>!s.call(e,r)||(t=!0,!1)),t}return!1}getContexts(){let e,t=[];return(e=void 0!==this.ctx&&this.ctx?NodeList.prototype.isPrototypeOf(this.ctx)?Array.prototype.slice.call(this.ctx):Array.isArray(this.ctx)?this.ctx:"string"==typeof this.ctx?Array.prototype.slice.call(document.querySelectorAll(this.ctx)):[this.ctx]:[]).forEach(e=>{const r=t.filter(t=>t.contains(e)).length>0;-1!==t.indexOf(e)||r||t.push(e)}),t}getIframeContents(e,t,r=(()=>{})){let s;try{const t=e.contentWindow;if(s=t.document,!t||!s)throw new Error("iframe inaccessible")}catch(e){r()}s&&t(s)}isIframeBlank(e){const t="about:blank",r=e.getAttribute("src").trim();return e.contentWindow.location.href===t&&r!==t&&r}observeIframeLoad(e,t,r){let s=!1,o=null;const a=()=>{if(!s){s=!0,clearTimeout(o);try{this.isIframeBlank(e)||(e.removeEventListener("load",a),this.getIframeContents(e,t,r))}catch(e){r()}}};e.addEventListener("load",a),o=setTimeout(a,this.iframesTimeout)}onIframeReady(e,t,r){try{"complete"===e.contentWindow.document.readyState?this.isIframeBlank(e)?this.observeIframeLoad(e,t,r):this.getIframeContents(e,t,r):this.observeIframeLoad(e,t,r)}catch(e){r()}}waitForIframes(e,t){let r=0;this.forEachIframe(e,()=>!0,e=>{r++,this.waitForIframes(e.querySelector("html"),()=>{--r||t()})},e=>{e||t()})}forEachIframe(e,t,r,s=(()=>{})){let o=e.querySelectorAll("iframe"),a=o.length,n=0;o=Array.prototype.slice.call(o);const i=()=>{--a<=0&&s(n)};a||i(),o.forEach(e=>{DOMIterator.matches(e,this.exclude)?i():this.onIframeReady(e,s=>{t(e)&&(n++,r(s)),i()},i)})}createIterator(e,t,r){return document.createNodeIterator(e,t,r)}isExcluded(e,t,r){const s=(t?e.parentNode.nodeName:e.nodeName).toUpperCase();return-1!==["SCRIPT","STYLE","TITLE","HEAD","HTML"].indexOf(s)||r(e)===NodeFilter.FILTER_REJECT}collectNodes(e,t,r){const s=[],o=this.createIterator(e,t,r);let a;for(;a=o.nextNode();)s.push(a);return s}iterateNodesIncludeShadowDOM(e,t,r,s){const o=t===NodeFilter.SHOW_TEXT,a=this.shadowDOM.style?this.createStyleElement():null;o&&(t=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT);const n=e=>{const i=this.createIterator(e,t);for(;e=i.nextNode();)e.nodeType===Node.ELEMENT_NODE?(o||r(e)!==NodeFilter.FILTER_ACCEPT||s(e),e.shadowRoot&&"open"===e.shadowRoot.mode&&(this.addRemoveStyle(e.shadowRoot,a,o),n(e.shadowRoot))):o&&e.nodeType===Node.TEXT_NODE&&r(e)===NodeFilter.FILTER_ACCEPT&&s(e)};n(e)}addRemoveStyle(e,t,r){if(r){if(!t||!e.firstChild||e.querySelector("style[data-markjs]"))return;e.insertBefore(t,e.firstChild)}else{let t=e.querySelector("style[data-markjs]");t&&e.removeChild(t)}}createStyleElement(){const e=document.createElement("style");return e.setAttribute("data-markjs","true"),e.textContent=this.shadowDOM.style,e}createInstanceOnIframe(e){return new DOMIterator(e.querySelector("html"),this.iframes)}compareNodeIframe(e,t,r){if(e.compareDocumentPosition(r)&Node.DOCUMENT_POSITION_PRECEDING){if(null===t)return!0;if(t.compareDocumentPosition(r)&Node.DOCUMENT_POSITION_FOLLOWING)return!0}return!1}getIteratorNode(e){const t=e.previousNode();let r;return{prevNode:t,node:r=null===t?e.nextNode():e.nextNode()&&e.nextNode()}}checkIframeFilter(e,t,r,s){let o=!1,a=!1;return s.forEach((e,t)=>{e.val===r&&(o=t,a=e.handled)}),this.compareNodeIframe(e,t,r)?(!1!==o||a?!1===o||a||(s[o].handled=!0):s.push({val:r,handled:!0}),!0):(!1===o&&s.push({val:r,handled:!1}),!1)}handleOpenIframes(e,t,r,s){e.forEach(e=>{e.handled||this.getIframeContents(e.val,e=>{this.createInstanceOnIframe(e).forEachNode(t,r,s)})})}iterateThroughNodes(e,t,r,s,o){if(this.iframes){let o=[],a=[];const n=this.createIterator(t,e,s);let i,h;const c=()=>(({prevNode:h,node:i}=this.getIteratorNode(n)),i);for(;c();)this.forEachIframe(t,e=>this.checkIframeFilter(i,h,e,o),t=>{this.createInstanceOnIframe(t).forEachNode(e,e=>a.push(e),s)}),a.push(i);a.forEach(e=>{r(e)}),this.handleOpenIframes(o,e,r,s)}else if(this.shadowDOM)this.iterateNodesIncludeShadowDOM(t,e,s,r);else{const o=this.createIterator(t,e,s);let a;for(;a=o.nextNode();)r(a)}o()}forEachNode(e,t,r,s=(()=>{})){const o=this.getContexts();let a=o.length;a||s(),o.forEach(o=>{const n=()=>{this.iterateThroughNodes(e,o,t,r,()=>{--a<=0&&s()})};this.iframes?this.waitForIframes(o,n):n()})}}class RegExpCreator{constructor(e){this.opt=Object.assign({},{diacritics:!0,synonyms:{},accuracy:"partially",caseSensitive:!1,ignoreJoiners:!1,ignorePunctuation:[],wildcards:"disabled"},e)}create(e,t){return"disabled"!==this.opt.wildcards&&(e=this.setupWildcardsRegExp(e)),e=this.escapeStr(e),Object.keys(this.opt.synonyms).length&&(e=this.createSynonymsRegExp(e)),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(e=this.setupIgnoreJoinersRegExp(e)),this.opt.diacritics&&(e=this.createDiacriticsRegExp(e)),e=this.createMergedBlanksRegExp(e),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(e=this.createJoinersRegExp(e)),"disabled"!==this.opt.wildcards&&(e=this.createWildcardsRegExp(e)),t?this.createAccuracyRegExp(e,!0):(e=this.createAccuracyRegExp(e,!1),new RegExp(e,`gm${this.opt.caseSensitive?"":"i"}`))}sortByLength(e){return e.sort((e,t)=>e.length===t.length?e>t?1:-1:t.length-e.length)}escapeStr(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}createSynonymsRegExp(e){const t=this.opt.synonyms,r=this.opt.caseSensitive?"":"i",s=this.opt.ignoreJoiners||this.opt.ignorePunctuation.length?"\0":"";for(let o in t)if(t.hasOwnProperty(o)){let a=Array.isArray(t[o])?t[o]:[t[o]];a.unshift(o),(a=this.sortByLength(a).map(e=>("disabled"!==this.opt.wildcards&&(e=this.setupWildcardsRegExp(e)),e=this.escapeStr(e))).filter(e=>""!==e)).length>1&&(e=e.replace(new RegExp(`(${a.map(e=>this.escapeStr(e)).join("|")})`,`gm${r}`),s+`(${a.map(e=>this.processSynonyms(e)).join("|")})`+s))}return e}processSynonyms(e){return(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(e=this.setupIgnoreJoinersRegExp(e)),e}setupWildcardsRegExp(e){return(e=e.replace(/(?:\\)*\?/g,e=>"\\"===e.charAt(0)?"?":"")).replace(/(?:\\)*\*/g,e=>"\\"===e.charAt(0)?"*":"")}createWildcardsRegExp(e){let t="withSpaces"===this.opt.wildcards;return e.replace(/\u0001/g,t?"[\\S\\s]?":"\\S?").replace(/\u0002/g,t?"[\\S\\s]*?":"\\S*")}setupIgnoreJoinersRegExp(e){return e.replace(/[^(|)\\]/g,(e,t,r)=>{let s=r.charAt(t+1);return/[(|)\\]/.test(s)||""===s?e:e+"\0"})}createJoinersRegExp(e){let t=[];const r=this.opt.ignorePunctuation;return Array.isArray(r)&&r.length&&t.push(this.escapeStr(r.join(""))),this.opt.ignoreJoiners&&t.push("\\u00ad\\u200b\\u200c\\u200d"),t.length?e.split(/\u0000+/).join(`[${t.join("")}]*`):e}createDiacriticsRegExp(e){const t=this.opt.caseSensitive?"":"i",r=this.opt.caseSensitive?["aàáảãạăằắẳẵặâầấẩẫậäåāą","AÀÁẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬÄÅĀĄ","cçćč","CÇĆČ","dđď","DĐĎ","eèéẻẽẹêềếểễệëěēę","EÈÉẺẼẸÊỀẾỂỄỆËĚĒĘ","iìíỉĩịîïī","IÌÍỈĨỊÎÏĪ","lł","LŁ","nñňń","NÑŇŃ","oòóỏõọôồốổỗộơởỡớờợöøō","OÒÓỎÕỌÔỒỐỔỖỘƠỞỠỚỜỢÖØŌ","rř","RŘ","sšśșş","SŠŚȘŞ","tťțţ","TŤȚŢ","uùúủũụưừứửữựûüůū","UÙÚỦŨỤƯỪỨỬỮỰÛÜŮŪ","yýỳỷỹỵÿ","YÝỲỶỸỴŸ","zžżź","ZŽŻŹ"]:["aàáảãạăằắẳẵặâầấẩẫậäåāąAÀÁẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬÄÅĀĄ","cçćčCÇĆČ","dđďDĐĎ","eèéẻẽẹêềếểễệëěēęEÈÉẺẼẸÊỀẾỂỄỆËĚĒĘ","iìíỉĩịîïīIÌÍỈĨỊÎÏĪ","lłLŁ","nñňńNÑŇŃ","oòóỏõọôồốổỗộơởỡớờợöøōOÒÓỎÕỌÔỒỐỔỖỘƠỞỠỚỜỢÖØŌ","rřRŘ","sšśșşSŠŚȘŞ","tťțţTŤȚŢ","uùúủũụưừứửữựûüůūUÙÚỦŨỤƯỪỨỬỮỰÛÜŮŪ","yýỳỷỹỵÿYÝỲỶỸỴŸ","zžżźZŽŻŹ"];let s=[];return e.split("").forEach(o=>{r.every(r=>{if(-1!==r.indexOf(o)){if(s.indexOf(r)>-1)return!1;e=e.replace(new RegExp(`[${r}]`,`gm${t}`),`[${r}]`),s.push(r)}return!0})}),e}createMergedBlanksRegExp(e){return e.replace(/[\s]+/gim,"[\\s]+")}createAccuracyRegExp(e,t){let r=this.opt.accuracy,s="string"==typeof r?r:r.value,o="string"==typeof r?[]:r.limiters,a="";o.forEach(e=>{a+=`|${this.escapeStr(e)}`});let n,i="()",h="";switch(s){case"partially":default:n=e;break;case"complementary":n=`[^${a="\\s"+(a||this.escapeStr("!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~¡¿"))}]*${e}[^${a}]*`;break;case"exactly":i=`(^|\\s${a})`,n=e,h=`(?=$|\\s${a})`}return t?{lookbehind:i,pattern:n,lookahead:h}:`${i}(${n})${h}`}}class Mark{constructor(e){this.ctx=e,this.cacheDict={},this.ie=!1;const t=window.navigator.userAgent;(t.indexOf("MSIE")>-1||t.indexOf("Trident")>-1)&&(this.ie=!0)}set opt(e){this._opt=Object.assign({},{element:"",className:"",exclude:[],iframes:!1,iframesTimeout:5e3,separateWordSearch:!0,acrossElements:!1,separateGroups:!1,wrapAllRanges:!1,ignoreGroups:0,each:()=>{},noMatch:()=>{},filter:()=>!0,done:()=>{},debug:!1,log:window.console},e)}get opt(){return this._opt}get iterator(){return new DOMIterator(this.ctx,this.opt.iframes,this.opt.exclude,this.opt.iframesTimeout,this.opt.shadowDOM)}log(e,t="debug"){const r=this.opt.log;this.opt.debug&&"object"==typeof r&&"function"==typeof r[t]&&r[t](`mark.js: ${e}`)}getSeparatedKeywords(e){let t=[];return e.forEach(e=>{this.opt.separateWordSearch?e.split(" ").forEach(e=>{e.trim()&&-1===t.indexOf(e)&&t.push(e)}):e.trim()&&-1===t.indexOf(e)&&t.push(e)}),{keywords:t.sort((e,t)=>t.length-e.length),length:t.length}}isNumeric(e){return Number(parseFloat(e))==e}checkRanges(e){if(!Array.isArray(e)||"[object Object]"!==Object.prototype.toString.call(e[0]))return this.log("markRanges() will only accept an array of objects"),this.opt.noMatch(e),[];const t=[];let r=0;return e.sort((e,t)=>e.start-t.start).forEach(e=>{let{start:s,end:o,valid:a}=this.callNoMatchOnInvalidRanges(e,r);a&&(e.start=s,e.length=o-s,t.push(e),this.opt.wrapAllRanges||(r=o))}),t}callNoMatchOnInvalidRanges(e,t){let r,s,o=!1;return e&&void 0!==e.start?(s=(r=parseInt(e.start,10))+parseInt(e.length,10),this.isNumeric(e.start)&&this.isNumeric(e.length)&&r>=t&&s>r?o=!0:(this.log("Ignoring invalid or overlapping range: "+`${JSON.stringify(e)}`),this.opt.noMatch(e))):(this.log(`Ignoring invalid range: ${JSON.stringify(e)}`),this.opt.noMatch(e)),{start:r,end:s,valid:o}}checkWhitespaceRanges(e,t,r){let s,o=!0,a=r.length,n=t-a,i=parseInt(e.start,10)-n;return(s=(i=i>a?a:i)+parseInt(e.length,10))>a&&(s=a,this.log(`End range automatically set to the max value of ${a}`)),i<0||s-i<=0?(o=!1,this.log(`Invalid range: ${JSON.stringify(e)}`),this.opt.noMatch(e)):/\S/.test(r.substring(i,s))||(o=!1,this.log("Skipping whitespace only range: "+JSON.stringify(e)),this.opt.noMatch(e)),{start:i,end:s,valid:o}}checkParents(e,t){if(e===e.parentNode.lastChild){if(t(e.parentNode))return!0;{let r=e.parentNode;for(;r.parentNode&&r===r.parentNode.lastChild;){if(t(r.parentNode))return!0;r=r.parentNode}}let r=e.parentNode.nextSibling;if(r){if(1!==r.nodeType)return!0;if(t(r))return!0}}return!1}checkNextSiblings(e,t){if(e&&1===e.nodeType){if(t(e))return;if(e.firstChild){let r,s=e.firstChild;for(;s;){if(1!==s.nodeType)return;if(t(s))return;r=s,s=s.firstChild}this.checkNextSiblings(r.nextSibling,t)}e!==e.parentNode.lastChild?this.checkNextSiblings(e.nextSibling,t):t(e.parentNode)}}prepare(e){let t=" ",r=this.opt.blockElementsBoundary;if(r.tagNames&&r.tagNames.length){let t={};for(let e in r.tagNames)t[r.tagNames[e].toLowerCase()]=1;for(let r in t)e[r]=2}else{for(let t in e)e[t]=2;e.br=1}return r.char&&(t=r.char.charAt(0)+" "),t}getTextNodesAcrossElements(e){if(this.opt.cacheTextNodes&&this.cacheDict.nodes)return this.cacheDict.lastIndex=0,this.cacheDict.lastTextIndex=0,void e(this.cacheDict);let t,r,s,o,a,n,i,h="",c=0,l=[],d=this.opt.blockElementsBoundary,p={div:1,p:1,li:1,td:1,tr:1,th:1,ul:1,ol:1,br:1,dd:1,dl:1,dt:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,blockquote:1,figcaption:1,figure:1,pre:1,table:1,thead:1,tbody:1,tfoot:1,input:1,img:1,nav:1,details:1,label:1,form:1,select:1,menu:1,menuitem:1,main:1,section:1,article:1,aside:1,picture:1,output:1,button:1,header:1,footer:1,address:1,area:1,canvas:1,map:1,fieldset:1,textarea:1,track:1,video:1,audio:1,body:1,iframe:1,meter:1,object:1,svg:1};d&&(n=this.prepare(p),i=" "+n),this.iterator.forEachNode(NodeFilter.SHOW_TEXT,e=>{if(a=0,t=h.length,r=e.textContent,s=/\s/.test(r[r.length-1]),d||!s){this.checkParents(e,e=>o=p[e.nodeName.toLowerCase()])||this.checkNextSiblings(e.nextSibling,e=>o=p[e.nodeName.toLowerCase()]),o&&(s?2===o&&(h+=r+n,a=2):1===o?(h+=r+" ",a=1):2===o&&(h+=r+i,a=3))}0===a&&(h+=r),l.push({start:t,end:h.length-a,offset:a,startOffset:c,node:e}),c-=a},e=>this.matchesExclude(e.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT,()=>{const t={value:h,nodes:l,lastIndex:0,lastTextIndex:0};this.opt.cacheTextNodes&&(this.cacheDict=t),e(t)})}getTextNodes(e){if(this.opt.cacheTextNodes&&this.cacheDict.nodes)return void e(this.cacheDict);let t="",r=[];this.iterator.forEachNode(NodeFilter.SHOW_TEXT,e=>{r.push({start:t.length,end:(t+=e.textContent).length,offset:0,node:e})},e=>this.matchesExclude(e.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT,()=>{const s={value:t,nodes:r,lastIndex:0,lastTextIndex:0};this.opt.cacheTextNodes&&(this.cacheDict=s),e(s)})}matchesExclude(e){const t=e.nodeName.toUpperCase();return-1!==["SCRIPT","STYLE","TITLE","HEAD","HTML"].indexOf(t)||this.opt.exclude&&this.opt.exclude.length&&DOMIterator.matches(e,this.opt.exclude)}wrapRangeInTextNode(e,t,r){const s=e.splitText(t),o=s.splitText(r-t);return this.createMarkElement(s),o}createMarkElement(e){const t=this.opt.element?this.opt.element:"mark";let r=document.createElement(t);return r.setAttribute("data-markjs","true"),this.opt.className&&r.setAttribute("class",this.opt.className),r.textContent=e.textContent,e.parentNode.replaceChild(r,e),r}wrapRangeInTextNodeInsert(e,t,r,s,o,a){let n=s===t.node.textContent.length;if(0===r&&n){let e=this.createMarkElement(t.node);return t.node=e.childNodes[0],{retNode:t,markNode:e,increment:0}}let i=t.node.splitText(r),h=i.splitText(s-r),c=this.createMarkElement(i),l=1,d={start:o,end:t.start+s,offset:0,node:c.childNodes[0]},p={start:t.start+s,end:t.end,offset:t.offset,node:h};return 0===r?e.nodes.splice(a,1,d,p):(n?e.nodes.splice(a+1,0,d):(e.nodes.splice(a+1,0,d,p),l=2),t.end=o,t.offset=0),{retNode:p,markNode:c,increment:l}}wrapRangeInMappedTextNode(e,t,r,s,o){let a=e.lastIndex,n=!0;if(this.opt.wrapAllRanges)for(;a>=0&&e.nodes[a].start>t;)a--;else if(t<e.lastTextIndex)return void this.log("The attempt to wrap overlapping range.");for(;a<e.nodes.length;a++)if(a+1===e.nodes.length||e.nodes[a+1].start>t){let i=e.nodes[a];if(!s(i)){a>e.lastIndex&&(e.lastIndex=a);break}const h=t-i.start,c=(r>i.end?i.end:r)-i.start;if(h>=0&&c>h){if(this.opt.wrapAllRanges){let r=this.wrapRangeInTextNodeInsert(e,i,h,c,t,a);i=r.retNode,o(r.markNode,n)}else i.node=this.wrapRangeInTextNode(i.node,h,c),i.start+=c,e.lastTextIndex=i.start,o(i.node.previousSibling,n);n=!1}if(!(r>i.end)){e.lastIndex=a;break}t=i.end+i.offset}}wrapGroups(e,t,r,s){return s((e=this.wrapRangeInTextNode(e,t,t+r)).previousSibling),e}separateGroupsD(e,t,r,s,o){let a,n,i=0,h=0,c=0,l=!1,d=0;for(;++c<t.length;)(a=t[c])&&(n=t.indices[c][0])>=i&&(d=t.indices[c][1],s(a,e,c)&&(e=this.wrapGroups(e,n-h,d-n,e=>{o(e,c)}),d>i&&(i=d),h=d,l=!0));return l?r.regex.lastIndex=0:0===t[0].length&&this.setLastIndex(r.regex,d),e}separateGroups(e,t,r,s,o){let a,n,i,h=t.index,c=-1,l=!1;for(;++c<r.groups.length;)(n=t[a=r.groups[c]])&&-1!==(i=e.textContent.indexOf(n,h))&&(s(n,e,a)?(e=this.wrapGroups(e,i,n.length,e=>{o(e,a)}),h=0,l=!0):h=i+n.length);return l&&(r.regex.lastIndex=0),e}wrapMatchGroupsD(e,t,r,s,o){let a,n,i,h=0,c=0,l=0;for(;++c<t.length;)(a=t[c])&&(n=t.indices[c][0],(this.opt.wrapAllRanges||n>=h)&&(l=t.indices[c][1],i=!1,this.wrapRangeInMappedTextNode(e,n,l,e=>s(a,e.node,c),(e,t)=>{i=!0,o(e,t,c)}),i&&l>h&&(h=l)));0===t[0].length&&this.setLastIndex(r.regex,l)}setLastIndex(e,t){t>e.lastIndex?e.lastIndex=t:t>0?e.lastIndex++:e.lastIndex=1/0}wrapMatchGroups(e,t,r,s,o){let a,n,i,h=0,c=0;const l=t.index,d=t[0];this.opt.wrapAllRanges&&this.wrapRangeInMappedTextNode(e,l,l+d.length,e=>s(d,e.node,c),function(e,t){o(e,t,c)});for(let p=0;p<r.groups.length;p++)c=r.groups[p],(a=t[c])&&(i=(n=d.indexOf(a,h))+a.length,-1!==n&&(this.wrapRangeInMappedTextNode(e,l+n,l+i,e=>s(a,e.node,c),(e,t)=>{o(e,t,c)}),h=i))}collectRegexGroupIndexes(e){let t=[],r=[],s=-1,o=1,a=0,n=!1,i=e.source,h=/^\(\?<(?![=!])|^\((?!\?)/;for(;++s<i.length;)switch(i[s]){case"(":n||(h.test(i.substring(s))?(r.push(1),0===a&&t.push(o),a++,o++):r.push(0));break;case")":n||1!==r.pop()||a--;break;case"\\":s++;break;case"[":n=!0;break;case"]":n=!1}return t}wrapSeparateGroups(e,t,r,s,o){const a=e.hasIndices?"separateGroupsD":"separateGroups",n={regex:e,groups:e.hasIndices?{}:this.collectRegexGroupIndexes(e)},i={abort:!1},h={execution:i};let c,l,d,p,g=0;this.getTextNodes(t=>{t.nodes.every(t=>{for(c=t.node,h.offset=t.start;null!==(l=e.exec(c.textContent))&&(e.hasIndices||""!==l[0])&&(h.match=l,d=p=!0,c=this[a](c,l,n,(e,t,s)=>(h.matchStart=d,h.groupIndex=s,d=!1,r(e,t,h)),(e,t)=>{p&&g++,s(e,{match:l,matchStart:p,count:g,groupIndex:t}),p=!1}),!i.abort););return!i.abort}),o(g)})}wrapMatches(e,t,r,s,o){const a=0===t?0:t+1,n={abort:!1},i={execution:n};let h,c,l,d=0;this.getTextNodes(t=>{for(let o=0;o<t.nodes.length;o++){for(h=t.nodes[o],c=h.node;null!==(l=e.exec(c.textContent))&&""!==l[a];){if(i.match=l,i.offset=h.start,!r(l[a],c,i))continue;let p=l[a].length,g=l.index;if(0!==a)for(let e=1;e<a;e++)g+=l[e].length;if(this.opt.cacheTextNodes){const r=this.wrapRangeInTextNodeInsert(t,h,g,g+p,h.start+g,o);if(d++,s(r.markNode,{match:l,count:d}),0===r.increment){e.lastIndex=0;break}o+=r.increment,h=r.retNode,c=h.node}else c=this.wrapGroups(c,g,p,e=>{s(e,{match:l,count:++d})});if(e.lastIndex=0,n.abort)break}if(n.abort)break}o(d)})}wrapGroupsAcrossElements(e,t,r,s,o){const a=e.hasIndices?"wrapMatchGroupsD":"wrapMatchGroups",n={regex:e,groups:e.hasIndices?{}:this.collectRegexGroupIndexes(e)},i={abort:!1},h={execution:i};let c,l,d,p=0;this.getTextNodesAcrossElements(t=>{for(;null!==(c=e.exec(t.value))&&(e.hasIndices||""!==c[0])&&(h.match=c,l=d=!0,this[a](t,c,n,(e,t,s)=>(h.matchStart=l,h.groupIndex=s,l=!1,r(e,t,h)),(e,t,r)=>{d&&p++,s(e,{match:c,matchStart:d,count:p,groupIndex:r,groupStart:t}),d=!1}),!i.abort););o(p)})}wrapMatchesAcrossElements(e,t,r,s,o){const a=0===t?0:t+1,n={abort:!1},i={execution:n};let h,c,l=0;this.getTextNodesAcrossElements(t=>{for(;null!==(h=e.exec(t.value))&&""!==h[a];){i.match=h,c=!0;let e=h.index;if(0!==a)for(let t=1;t<a;t++)e+=h[t].length;const o=e+h[a].length;if(this.wrapRangeInMappedTextNode(t,e,o,e=>(i.matchStart=c,i.offset=e.startOffset,c=!1,r(h[a],e.node,i)),(e,t)=>{t&&l++,s(e,{match:h,matchStart:t,count:l})}),n.abort)break}o(l)})}wrapRangeFromIndex(e,t,r,s){let o=0;this.getTextNodes(a=>{const n=a.value.length;e.forEach((e,s)=>{let{start:i,end:h,valid:c}=this.checkWhitespaceRanges(e,n,a.value);c&&this.wrapRangeInMappedTextNode(a,i,h,r=>t(r.node,e,a.value.substring(i,h),s),(t,s)=>{s&&o++,r(t,e,{matchStart:s,count:o})})}),s(o)})}unwrapMatches(e){const t=e.parentNode;let r=document.createDocumentFragment();for(;e.firstChild;)r.appendChild(e.removeChild(e.firstChild));t.replaceChild(r,e),this.ie?this.normalizeTextNode(t):t.normalize()}normalizeTextNode(e){if(e){if(3===e.nodeType)for(;e.nextSibling&&3===e.nextSibling.nodeType;)e.nodeValue+=e.nextSibling.nodeValue,e.parentNode.removeChild(e.nextSibling);else this.normalizeTextNode(e.firstChild);this.normalizeTextNode(e.nextSibling)}}markRegExp(e,t){this.opt=t;let r=0,s=this.getMethodName(t);if(this.opt.acrossElements&&!e.global&&!e.sticky){let t=e.toString().split("/");e=new RegExp(e.source,"g"+t[t.length-1]),this.log("RegExp is recompiled with g flag because it must have g flag")}this.log(`Searching with expression "${e}"`),this[s](e,this.opt.ignoreGroups,(e,t,s)=>this.opt.filter(t,e,r,s),(e,t)=>{r++,this.opt.each(e,t)},t=>{0===t&&this.opt.noMatch(e),this.opt.done(r,t)})}mark(e,t){if(this.opt=t,this.opt.combinePatterns)return void this.markCombinePatterns(e,t);let r=0,s=0,o=0;const a=this.opt.acrossElements?"wrapMatchesAcrossElements":"wrapMatches",n={},{keywords:i,length:h}=this.getSeparatedKeywords("string"==typeof e?[e]:e),c=e=>{const t=new RegExpCreator(this.opt).create(e);let l=0;this.log(`Searching with expression "${t}"`),this[a](t,1,(t,r,o)=>this.opt.filter(r,e,s,l,o),(e,t)=>{l++,s++,this.opt.each(e,t)},t=>{o+=t,0===t&&this.opt.noMatch(e),n[e]=t,++r<h?c(i[r]):this.opt.done(s,o,n)})};0===h?this.opt.done(0,0,n):c(i[r])}markCombinePatterns(e,t){this.opt=t;let r,s=0,o=0,a=0,n=[],i=[];const h=this.opt.acrossElements,c=h?"wrapMatchesAcrossElements":"wrapMatches",l=`gm${this.opt.caseSensitive?"":"i"}`,d={},p=this.getSeparatedKeywords("string"==typeof e?[e]:e),g=e=>{const t=new RegExp(e,l),p=i[s];this.log(`Searching with expression "${t}"`),this[c](t,1,(e,t,s)=>(h?s.matchStart&&(r=this.getCurrentTerm(s.match,p)):r=this.getCurrentTerm(s.match,p),this.opt.filter(t,r,o,d[r],s)),(e,t)=>{o++,h?t.matchStart&&(d[r]+=1):d[r]+=1,this.opt.each(e,t)},e=>{a+=e;const t=p.filter(e=>0===d[e]);t.length&&this.opt.noMatch(t),++s<n.length?g(n[s]):this.opt.done(o,a,d)})};if(0===p.length)this.opt.done(0,0,d);else{p.keywords.forEach(e=>{d[e]=0});const e=this.getPatterns(p.keywords);i=e.terms,n=e.patterns,g(n[s])}}getCurrentTerm(e,t){let r=e.length;for(;--r>2;)if(e[r])return t[r-3];return" "}getPatterns(e){const t=new RegExpCreator(this.opt),r=t.create(e[0],!0),s=[],o=[];let a=10;if("number"==typeof this.opt.combinePatterns)if(this.opt.combinePatterns===1/0)a=1|Number.MAX_VALUE;else{const e=parseInt(this.opt.combinePatterns);this.isNumeric(e)&&(a=e)}let n=Math.ceil(e.length/a);for(let i=0;i<n;i++){let n=[],h=r.lookbehind+"(",c=Math.min(i*a+a,e.length);for(let r=i*a;r<c;r++){h+=`(${t.create(e[r],!0).pattern})${r<c-1?"|":""}`,n.push(e[r])}s.push(h+")"+r.lookahead),o.push(n)}return{patterns:s,terms:o}}getMethodName(e){if(e){if(e.acrossElements)return e.separateGroups?"wrapGroupsAcrossElements":"wrapMatchesAcrossElements";if(e.separateGroups)return"wrapSeparateGroups"}return"wrapMatches"}markRanges(e,t){this.opt=t;let r=0,s=this.checkRanges(e);s&&s.length?(this.log("Starting to mark with the following ranges: "+JSON.stringify(s)),this.wrapRangeFromIndex(s,(e,t,r,s)=>this.opt.filter(e,t,r,s),(e,t,s)=>{r++,this.opt.each(e,t,s)},e=>{this.opt.done(r,e)})):this.opt.done(0,0)}unmark(e){this.opt=e;let t=(this.opt.element?this.opt.element:"mark")+"[data-markjs]";this.opt.className&&(t+=`.${this.opt.className}`),this.log(`Removal selector "${t}"`),this.iterator.forEachNode(NodeFilter.SHOW_ELEMENT,e=>{this.unwrapMatches(e)},e=>DOMIterator.matches(e,t)&&!this.matchesExclude(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT,this.opt.done)}}$.fn.mark=function(e,t){return new Mark(this.get()).mark(e,t),this},$.fn.markRegExp=function(e,t){return new Mark(this.get()).markRegExp(e,t),this},$.fn.markRanges=function(e,t){return new Mark(this.get()).markRanges(e,t),this},$.fn.unmark=function(e){return new Mark(this.get()).unmark(e),this};export default $;
