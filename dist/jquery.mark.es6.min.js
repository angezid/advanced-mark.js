/*!***************************************************
* advanced-mark.js v2.0.0
* https://github.com/angezid/advanced-mark#readme
* MIT licensed
* Copyright (c) 2022–2023, angezid
* Original author Julian Kühnel, license https://git.io/vwTVl
*****************************************************/
import"./jquery.js";class t{constructor(t,e){this.ctx=t,this.opt=e,this.attrName="data-markjsListener"}static matches(t,e){if(!e||!e.length)return!1;const s="string"==typeof e?[e]:e,r=t.matches||t.matchesSelector||t.msMatchesSelector||t.mozMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector;return r&&s.some((e=>!0===r.call(t,e)))}getContexts(){let t,e=!1;void 0!==this.ctx&&this.ctx?NodeList.prototype.isPrototypeOf(this.ctx)?t=Array.prototype.slice.call(this.ctx):Array.isArray(this.ctx)?(t=this.ctx,e=!0):t="string"==typeof this.ctx?Array.prototype.slice.call(document.querySelectorAll(this.ctx)):[this.ctx]:t=[];const s=[];return t.forEach((t=>{-1!==s.indexOf(t)||s.some((e=>e.contains(t)))||s.push(t)})),e&&s.sort(((t,e)=>(t.compareDocumentPosition(e)&Node.DOCUMENT_POSITION_FOLLOWING)>0?-1:1)),s}getIframeContents(t,e,s){try{const s=t.contentWindow.document;s&&(t.setAttribute(this.attrName,"completed"),e({iframe:t,context:s}))}catch(e){t.setAttribute(this.attrName,"error"),s({iframe:t,error:e})}}isIframeBlank(t){const e="about:blank",s=t.getAttribute("src").trim();return t.contentWindow.location.href===e&&s!==e&&s}observeIframeLoad(t,e,s){if(t.hasAttribute(this.attrName))return;let r=null;const o=()=>{clearTimeout(r),t.removeEventListener("load",o),this.getIframeContents(t,e,s)};t.addEventListener("load",o),t.setAttribute(this.attrName,!0),r=setTimeout(o,this.opt.iframesTimeout)}onIframeReady(t,e,s){try{"complete"===t.contentWindow.document.readyState?this.isIframeBlank(t)?this.observeIframeLoad(t,e,s):this.getIframeContents(t,e,s):this.observeIframeLoad(t,e,s)}catch(t){s(t)}}waitForAllIframes(e,s){let r=0,o=[],a=[],i=!1;const n=setTimeout((()=>{i=!0,s()}),this.opt.iframesTimeout),c=()=>{clearTimeout(n),i||s()},h=()=>{r===o.filter((t=>!this.hasAttributeValue(t,this.attrName,"error"))).length&&c()},l=e=>{e.iframe&&"about:blank"===e.context.location.href||(a=[],e.context.querySelectorAll(e.iframe?"body iframe":"iframe").forEach((e=>{t.matches(e,this.opt.exclude)||(o.push(e),e.hasAttribute(this.attrName)||a.push(e))})),e.iframe||a.length)?a.length?a.forEach((t=>{this.onIframeReady(t,(t=>{r++,l(t)}),(t=>{this.opt.debug&&console.log(t.error),h()}))})):h():c()};l({context:e})}createIterator(t,e,s){return document.createNodeIterator(t,e,s,!1)}addRemoveStyle(t,e,s){if(s){if(!e||!t.firstChild||t.querySelector("style[data-markjs]"))return;t.insertBefore(e,t.firstChild)}else{let e=t.querySelector("style[data-markjs]");e&&t.removeChild(e)}}createStyleElement(){const t=document.createElement("style");return t.setAttribute("data-markjs","true"),t.textContent=this.opt.shadowDOM.style,t}hasAttributeValue(t,e,s){return t.hasAttribute(e)&&t.getAttribute(e)===s}iterateThroughNodes(e,s,r,o,a){const i=this.opt.shadowDOM,n=this.opt.iframes;if(n||i){const a=0!=(s&NodeFilter.SHOW_ELEMENT),c=0!=(s&NodeFilter.SHOW_TEXT),h=i&&i.style?this.createStyleElement():null;c&&(s=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT);const l=e=>{const d=this.createIterator(e,s);for(;e=d.nextNode();)e.nodeType===Node.ELEMENT_NODE?(a&&r(e)===NodeFilter.FILTER_ACCEPT&&o(e),n&&"IFRAME"===e.nodeName.toUpperCase()&&!t.matches(e,this.opt.exclude)&&this.hasAttributeValue(e,this.attrName,"completed")&&this.getIframeContents(e,(t=>{l(t.context)}),(()=>{})),i&&e.shadowRoot&&"open"===e.shadowRoot.mode&&(this.addRemoveStyle(e.shadowRoot,h,c),l(e.shadowRoot))):c&&e.nodeType===Node.TEXT_NODE&&r(e)===NodeFilter.FILTER_ACCEPT&&o(e)};l(e)}else{const t=this.createIterator(e,s,r);let a;for(;a=t.nextNode();)o(a)}a()}forEachNode(t,e,s,r=(()=>{})){const o=this.getContexts();let a=o.length;a||r(),o.forEach((o=>{a--;const i=()=>{this.iterateThroughNodes(o,t,s,e,(()=>{a<=0&&r()}))};this.opt.iframes?this.waitForAllIframes(o,i):i()}))}}class e{constructor(t){this.opt=Object.assign({},{diacritics:!0,synonyms:{},accuracy:"partially",caseSensitive:!1,ignoreJoiners:!1,ignorePunctuation:[],wildcards:"disabled"},t)}create(t,e){t=this.checkWildcardsEscape(t),Object.keys(this.opt.synonyms).length&&(t=this.createSynonyms(t));const s=this.getJoinersPunctuation();s&&(t=this.setupIgnoreJoiners(t)),this.opt.diacritics&&(t=this.createDiacritics(t)),t=t.replace(/\s+/g,"[\\s]+"),s&&(t=this.createJoiners(t,s)),"disabled"!==this.opt.wildcards&&(t=this.createWildcards(t));const r=this.createAccuracy(t);return e?r:new RegExp(`${r.lookbehind}(${r.pattern})${r.lookahead}`,"g"+(this.opt.caseSensitive?"":"i"))}createCombinePattern(t,e){if(!Array.isArray(t)||!t.length)return null;const s=e?"(":"(?:",r=this.create(t[0],!0),o=r.lookbehind,a=r.lookahead;return{lookbehind:o,pattern:this.distinct(t.map((t=>`${s}${this.create(t,!0).pattern})`))).join("|"),lookahead:a}}sortByLength(t){return t.sort(((t,e)=>t.length===e.length?t>e?1:-1:e.length-t.length))}escape(t){return t.replace(/[[\]/{}()*+?.\\^$|]/g,"\\$&")}escapeCharSet(t){return t.replace(/[-^\]\\]/g,"\\$&")}toArrayIfString(t){return t&&t.length?this.distinct("string"==typeof t?t.split(""):t):[]}distinct(t){const e=[];return t.forEach((t=>{t.trim()&&-1===e.indexOf(t)&&e.push(t)})),e}createSynonyms(t){const e=this.opt.synonyms,s="g"+(this.opt.caseSensitive?"":"i");for(const r in e)if(e.hasOwnProperty(r)){let o=Array.isArray(e[r])?e[r]:[e[r]];if(o.unshift(r),o=this.sortByLength(this.distinct(o)).map((t=>this.checkWildcardsEscape(t))),o.length>1){const e=o.map((t=>this.escape(t))).join("|");t=t.replace(new RegExp(e,s),`(?:${o.join("|")})`)}}return t}checkWildcardsEscape(t){return"disabled"!==this.opt.wildcards&&(t=t.replace(/(\\)*\?/g,((t,e)=>e?"?":"")).replace(/(\\)*\*/g,((t,e)=>e?"*":""))),this.escape(t)}createWildcards(t){let e="withSpaces"===this.opt.wildcards;return t.replace(/\u0001/g,e?"[\\S\\s]?":"\\S?").replace(/\u0002/g,e?"[\\S\\s]*?":"\\S*")}setupIgnoreJoiners(t){return t.replace(/(\(\?:|\|)|\\?.(?=([|)]|$)|.)/g,((t,e,s)=>e||void 0!==s?t:t+"\0"))}createJoiners(t,e){return t.split(/\u0000+/).join(`[${e}]*`)}getJoinersPunctuation(){let t=this.toArrayIfString(this.opt.ignorePunctuation),e="";return t.length&&(e=this.escapeCharSet(t.join(""))),this.opt.ignoreJoiners&&(e+="\\u00ad\\u200b\\u200c\\u200d"),e}createDiacritics(t){const e=this.opt.caseSensitive,s=["aàáảãạăằắẳẵặâầấẩẫậäåāą","AÀÁẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬÄÅĀĄ","cçćč","CÇĆČ","dđď","DĐĎ","eèéẻẽẹêềếểễệëěēę","EÈÉẺẼẸÊỀẾỂỄỆËĚĒĘ","iìíỉĩịîïī","IÌÍỈĨỊÎÏĪ","lł","LŁ","nñňń","NÑŇŃ","oòóỏõọôồốổỗộơởỡớờợöøō","OÒÓỎÕỌÔỒỐỔỖỘƠỞỠỚỜỢÖØŌ","rř","RŘ","sšśșş","SŠŚȘŞ","tťțţ","TŤȚŢ","uùúủũụưừứửữựûüůū","UÙÚỦŨỤƯỪỨỬỮỰÛÜŮŪ","yýỳỷỹỵÿ","YÝỲỶỸỴŸ","zžżź","ZŽŻŹ"];return t.split("").map((t=>{for(let r=0;r<s.length;r+=2)if(e){if(-1!==s[r].indexOf(t))return"["+s[r]+"]";if(-1!==s[r+1].indexOf(t))return"["+s[r+1]+"]"}else if(-1!==s[r].indexOf(t)||-1!==s[r+1].indexOf(t))return"["+s[r]+s[r+1]+"]";return t})).join("")}createAccuracy(t){let e,s=this.opt.accuracy,r="()",o=t,a="";if("string"!=typeof s&&(e=this.toArrayIfString(s.limiters),e=e.length?e:null,s=s.value),"complementary"===s){let s="\\s"+(e?this.escapeCharSet(e.join("")):"!\"#$%&'()*+,\\-./:;<=>?@[\\]\\\\^_`{|}~¡¿");o=`[^${s}]*${t}[^${s}]*`}else if("exactly"===s){let t=e?"|"+e.map((t=>this.escape(t))).join("|"):"";r=`(^|\\s${t})`,a=`(?=$|\\s${t})`}return{lookbehind:r,pattern:o,lookahead:a}}}class s{constructor(t){this.version="2.0.0",this.ctx=t,this.cacheDict={},this.empty=document.createTextNode(""),this.nodeNames=["script","style","title","head","html"]}set opt(t){this._opt=Object.assign({},{element:"",className:"",exclude:[],iframes:!1,iframesTimeout:5e3,separateWordSearch:!0,acrossElements:!1,ignoreGroups:0,each:()=>{},noMatch:()=>{},filter:()=>!0,done:()=>{},allDone:()=>{},debug:!1,log:window.console},t)}get opt(){return this._opt}get iterator(){return new t(this.ctx,this.opt)}log(t,e="debug"){const s=this.opt.log;this.opt.debug&&"object"==typeof s&&"function"==typeof s[e]&&s[e](`mark.js: ${t}`)}report(t){t.forEach((t=>{this.log(`${t.text} ${JSON.stringify(t.obj)}`,t.level?t.level:"debug"),t.skip||this.opt.noMatch(t.obj)}))}checkOption(t){t&&t.acrossElements&&t.cacheTextNodes&&!t.wrapAllRanges&&(t=Object.assign({},t,{wrapAllRanges:!0}));let e=!0;return t&&t.cacheTextNodes&&this.cacheDict.type&&(t.acrossElements?"across"===this.cacheDict.type&&(e=!1):"every"===this.cacheDict.type&&(e=!1)),e&&(this.cacheDict={}),t}getSeachTerms(t){const e=this.isString(t)?[t]:t,s=[],r=t=>{t.trim()&&-1===s.indexOf(t)&&s.push(t)};return e.forEach((t=>{this.opt.separateWordSearch?t.split(" ").forEach((t=>r(t))):r(t)})),s.sort(((t,e)=>e.length-t.length)),s}isNumeric(t){return Number(parseFloat(t))==t}isString(t){return"string"==typeof t}isObject(t){return"[object Object]"===Object.prototype.toString.call(t)}isArrayOfObjects(t){return Array.isArray(t)&&t.some((t=>this.isObject(t)))}isRegExp(t){return"[object RegExp]"===Object.prototype.toString.call(t)}checkRanges(t,e,s){const r="error",o=t.filter((t=>{let o=!1;return this.isNumeric(t.start)&&this.isNumeric(t.length)&&(t.start=parseInt(t.start),t.length=parseInt(t.length),t.start>=0&&t.start<s&&t.length>0&&(o=!0)),!!o||(e.push({text:"Ignoring invalid range: ",obj:t,level:r}),!1)})).sort(((t,e)=>t.start-e.start));if(this.opt.wrapAllRanges)return o;let a,i=0;return o.filter((t=>t.start>=i?(i=t.start+t.length,!0):(a=t.start+t.length<i?"nesting":"overlapping",e.push({text:`Ignoring ${a} range: `,obj:t,level:r}),!1)))}setType(t){const e=this.opt.blockElementsBoundary,s=Array.isArray(e.tagNames)&&e.tagNames.length;if(s&&e.tagNames.map((t=>t.toLowerCase())).forEach((e=>{t[e]=2})),!s||e.extend)for(const e in t)t[e]=2;t.br=1}getTextNodesAcross(t){if(this.opt.cacheTextNodes&&this.cacheDict.nodes)return this.cacheDict.lastIndex=0,this.cacheDict.lastTextIndex=0,void t(this.cacheDict);let e={div:1,p:1,li:1,td:1,tr:1,th:1,ul:1,ol:1,br:1,dd:1,dl:1,dt:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,blockquote:1,figcaption:1,figure:1,pre:1,table:1,thead:1,tbody:1,tfoot:1,input:1,img:1,nav:1,details:1,label:1,form:1,select:1,menu:1,menuitem:1,main:1,section:1,article:1,aside:1,picture:1,output:1,button:1,header:1,footer:1,address:1,area:1,canvas:1,map:1,fieldset:1,textarea:1,track:1,video:1,audio:1,body:1,iframe:1,meter:1,object:1,svg:1};const s=this.opt.blockElementsBoundary;let r,o,a,i,n="";s&&(this.setType(e),s.char&&(n=s.char.charAt(0)));const c={nodes:[],text:"",regex:/\s/,tags:e,boundary:s,startOffset:0,str:n,str1:" "+n,str2:n+" ",str3:" "+n+" "};this.iterator.forEachNode(NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,(t=>{a?(a=t,this.getNodeInfo(o,t,i,c),o=t,i=null):o=a=t}),(t=>t.nodeType===Node.ELEMENT_NODE?(i?s&&2!==i&&2===(r=e[t.nodeName.toLowerCase()])&&(i=r):i=e[t.nodeName.toLowerCase()],NodeFilter.FILTER_REJECT):this.excludeElements(t.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT),(()=>{a&&this.getNodeInfo(o,a,i,c);const e={text:c.text,nodes:c.nodes,lastIndex:0,lastTextIndex:0};this.opt.cacheTextNodes&&(this.cacheDict=e,this.cacheDict.type="across"),t(e)}))}getNodeInfo(t,e,s,r){let o=0;const a=r.text.length,i=t.textContent;if(t!==e){const a=r.regex.test(i[i.length-1]),n=r.regex.test(e.textContent[0]);if(r.boundary||!a&&!n){let c=s;if(!s){let o=t.parentNode;for(;o;){if(s=r.tags[o.nodeName.toLowerCase()]){c=!(o===e.parentNode||o.contains(e));break}o=o.parentNode}}if(c)if(a||n){if(2===s){let t=n&&a?r.str:n?r.str1:r.str2;r.text+=i+t,o=t.length}}else 1===s?(r.text+=i+" ",o=1):2===s&&(r.text+=i+r.str3,o=3)}}0===o&&(r.text+=i),r.nodes.push(this.createInfo(t,a,r.text.length-o,o,r.startOffset)),r.startOffset-=o}getTextNodes(t){if(this.opt.cacheTextNodes&&this.cacheDict.nodes)return void t(this.cacheDict);let e="",s=[];this.iterator.forEachNode(NodeFilter.SHOW_TEXT,(t=>{s.push({start:e.length,end:(e+=t.textContent).length,offset:0,node:t})}),(t=>this.excludeElements(t.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT),(()=>{const r={text:e,nodes:s,lastIndex:0,lastTextIndex:0};this.opt.cacheTextNodes&&(this.cacheDict=r,this.cacheDict.type="every"),t(r)}))}excludeElements(e){return-1!==this.nodeNames.indexOf(e.nodeName.toLowerCase())||t.matches(e,this.opt.exclude)}wrapRangeInsert(t,e,s,r,o,a){const i=r===e.node.textContent.length;let n,c,h=0;if(0===s){if(i){const t=this.wrapTextNode(e.node);return e.node=t.childNodes[0],{markNode:t,nodeInfo:this.createInfo(this.empty,e.end,e.end,e.offset,0),increment:0}}n=e.node.splitText(r),c=e.node,h=1}else i?(c=e.node.splitText(s),n=this.empty,h=2):(c=e.node.splitText(s),n=c.splitText(r-s),h=3);const l=this.wrapTextNode(c),d=this.createInfo(l.childNodes[0],1===h?e.start:o,e.start+r,0,e.startOffset),p=this.createInfo(n,2===h?e.end:e.start+r,e.end,e.offset,e.startOffset);return 1===h?t.nodes.splice(a,1,d,p):(2===h?t.nodes.splice(a+1,0,d):t.nodes.splice(a+1,0,d,p),e.end=o,e.offset=0),{markNode:l,nodeInfo:p,increment:h<3?1:2}}createInfo(t,e,s,r,o){return{node:t,start:e,end:s,offset:r,startOffset:o}}wrapTextNode(t){const e=this.opt.element?this.opt.element:"mark";let s=document.createElement(e);return s.setAttribute("data-markjs","true"),this.opt.className&&s.setAttribute("class",this.opt.className),s.textContent=t.textContent,t.parentNode.replaceChild(s,t),s}wrapRange(t,e,s,r){let o,a=this.empty,i=s===t.textContent.length;return 0===e?(i||(a=t.splitText(s)),o=t):i?o=t.splitText(e):(o=t.splitText(e),a=o.splitText(s-e)),r(this.wrapTextNode(o)),a}wrapRangeAcross(t,e,s,r,o){let a=t.lastIndex,i=!0;if(this.opt.wrapAllRanges)for(;a>=0&&t.nodes[a].start>e;)a--;else if(e<t.lastTextIndex)return;for(;a<t.nodes.length;a++)if(a+1===t.nodes.length||t.nodes[a+1].start>e){let n=t.nodes[a];if(!r(n)){a>t.lastIndex&&(t.lastIndex=a);break}const c=e-n.start,h=(s>n.end?n.end:s)-n.start;if(c>=0&&h>c){if(this.opt.wrapAllRanges){const s=this.wrapRangeInsert(t,n,c,h,e,a);n=s.nodeInfo,o(s.markNode,i)}else n.node=this.wrapRange(n.node,c,h,(t=>{o(t,i)})),n.start+=h,t.lastTextIndex=n.start;i=!1}if(!(s>n.end)){t.lastIndex=a;break}e=n.end+n.offset}}wrapGroups(t,e,s,r,o){let a,i,n,c=e.index,h=-1,l=!1;for(;++h<s.groups.length;)a=s.groups[h],i=e[a],i&&(n=t.textContent.indexOf(i,c),-1!==n&&(r(t,i,a)?(t=this.wrapRange(t,n,n+i.length,(t=>{o(t,a)})),c=0,l=!0):c=n+i.length));return l&&(s.regex.lastIndex=0),t}wrapGroupsAcross(t,e,s,r,o){let a,i,n,c=0,h=0;const l=e.index,d=e[0];this.opt.wrapAllRanges&&this.wrapRangeAcross(t,l,l+d.length,(t=>r(t.node,d,h)),((t,e)=>{o(t,e,h)}));for(let p=0;p<s.groups.length;p++)h=s.groups[p],a=e[h],a&&(i=d.indexOf(a,c),n=i+a.length,-1!==i&&(this.wrapRangeAcross(t,l+i,l+n,(t=>r(t.node,a,h)),((t,e)=>{o(t,e,h)})),c=n))}wrapGroupsDFlag(t,e,s,r,o){let a,i,n=0,c=0,h=0,l=!1,d=0;for(;++h<e.length;)a=e[h],a&&(i=e.indices[h][0],i>=n&&(d=e.indices[h][1],r(t,a,h)&&(t=this.wrapRange(t,i-c,d-c,(t=>{o(t,h)})),d>n&&(n=d),c=d,l=!0)));return l?s.regex.lastIndex=0:0===e[0].length&&this.setLastIndex(s.regex,d),t}wrapGroupsDFlagAcross(t,e,s,r,o){let a,i,n,c=0,h=0,l=0;for(;++h<e.length;)a=e[h],a&&(i=e.indices[h][0],(this.opt.wrapAllRanges||i>=c)&&(l=e.indices[h][1],n=!1,this.wrapRangeAcross(t,i,l,(t=>r(t.node,a,h)),((t,e)=>{n=!0,o(t,e,h)})),n&&l>c&&(c=l)));0===e[0].length&&this.setLastIndex(s.regex,l)}setLastIndex(t,e){e>t.lastIndex?t.lastIndex=e:e>0?t.lastIndex++:t.lastIndex=1/0}collectRegexGroupIndexes(t){let e=[],s=[],r=-1,o=1,a=0,i=!1,n=t.source,c=/^\(\?<(?![=!])|^\((?!\?)/;for(;++r<n.length;)switch(n[r]){case"(":i||(c.test(n.substring(r))?(s.push(1),0===a&&e.push(o),a++,o++):s.push(0));break;case")":i||1!==s.pop()||a--;break;case"\\":r++;break;case"[":i=!0;break;case"]":i=!1}return e}wrapSeparateGroups(t,e,s,r,o){const a=t.hasIndices,i=a?"wrapGroupsDFlag":"wrapGroups",n={regex:t,groups:a?{}:this.collectRegexGroupIndexes(t)},c={abort:!1},h={execution:c};let l,d,p,u,g=0;this.getTextNodes((e=>{e.nodes.every((e=>{for(l=e.node,h.offset=e.start;null!==(d=t.exec(l.textContent))&&(a||""!==d[0])&&(h.match=d,p=u=!0,l=this[i](l,d,n,((t,e,r)=>(h.matchStart=p,h.groupIndex=r,p=!1,s(t,e,h))),((t,e)=>{u&&g++,r(t,{match:d,matchStart:u,count:g,groupIndex:e}),u=!1})),!c.abort););return!c.abort})),o(g)}))}wrapSeparateGroupsAcross(t,e,s,r,o){const a=t.hasIndices,i=a?"wrapGroupsDFlagAcross":"wrapGroupsAcross",n={regex:t,groups:a?{}:this.collectRegexGroupIndexes(t)},c={abort:!1},h={execution:c};let l,d,p,u=0;this.getTextNodesAcross((e=>{for(;null!==(l=t.exec(e.text))&&(a||""!==l[0])&&(h.match=l,d=p=!0,this[i](e,l,n,((t,e,r)=>(h.matchStart=d,h.groupIndex=r,d=!1,s(t,e,h))),((t,e,s)=>{p&&u++,r(t,{match:l,matchStart:p,count:u,groupIndex:s,groupStart:e}),p=!1})),!c.abort););o(u)}))}wrapMatches(t,e,s,r,o){const a=0===e?0:e+1,i={abort:!1},n={execution:i},c={};let h,l,d,p,u=0;this.getTextNodes((e=>{for(let o=0;o<e.nodes.length;o++){for(h=e.nodes[o],l=h.node;null!==(d=t.exec(l.textContent))&&""!==(p=d[a]);){if(n.match=d,n.offset=h.start,!s(l,p,n))continue;let g=0,m=d.index;for(;++g<a;)m+=d[g].length;const f=m+p.length;if(this.opt.cacheTextNodes){const s=this.wrapRangeInsert(e,h,m,f,h.start+m,o);if(c.match=d,c.count=++u,r(s.markNode,c),0===s.increment){t.lastIndex=0;break}o+=s.increment,h=s.nodeInfo,l=h.node}else l=this.wrapRange(l,m,f,(t=>{u++,r(t,{match:d,count:u})}));if(t.lastIndex=0,i.abort)break}if(i.abort)break}o(u)}))}wrapMatchesAcross(t,e,s,r,o){const a=0===e?0:e+1,i={abort:!1},n={execution:i};let c,h,l,d=0;this.getTextNodesAcross((e=>{for(;null!==(c=t.exec(e.text))&&""!==(h=c[a]);){n.match=c,l=!0;let t=0,o=c.index;for(;++t<a;)o+=c[t].length;if(this.wrapRangeAcross(e,o,o+h.length,(t=>(n.matchStart=l,n.offset=t.startOffset,l=!1,s(t.node,h,n))),((t,e)=>{e&&d++,r(t,{match:c,matchStart:e,count:d})})),i.abort)break}o(d)}))}wrapRanges(t,e,s,r){const o=[],a=[],i="warn";let n=0;this.getTextNodes((c=>{const h=c.text.length,l=this.checkRanges(t,o,h);l.forEach(((t,r)=>{let l=t.start+t.length;l>h&&(o.push({text:"Range length was limited to: "+(l-h),obj:t,skip:!0,level:i}),l=h);const d=c.text.substring(t.start,l);d.trim()?this.wrapRangeAcross(c,t.start,l,(s=>e(s.node,t,d,r)),((e,r)=>{r&&n++,s(e,t,{matchStart:r,count:n})})):(o.push({text:"Skipping whitespace only range: ",obj:t,level:i}),a.push(t))})),this.log(`Valid ranges: ${JSON.stringify(l.filter((t=>-1===a.indexOf(t))))}`),r(n,o)}))}unwrapMatches(t){const e=t.parentNode,s=t.firstChild;if(1===t.childNodes.length)if(3===s.nodeType){const r=t.previousSibling,o=t.nextSibling;if(r&&3===r.nodeType)o&&3===o.nodeType?(r.nodeValue+=s.nodeValue+o.nodeValue,e.removeChild(o)):r.nodeValue+=s.nodeValue;else{if(!o||3!==o.nodeType)return void e.replaceChild(t.firstChild,t);o.nodeValue=s.nodeValue+o.nodeValue}e.removeChild(t)}else e.replaceChild(t.firstChild,t);else{if(s){let s=document.createDocumentFragment();for(;t.firstChild;)s.appendChild(t.removeChild(t.firstChild));e.replaceChild(s,t)}else e.removeChild(t);e.normalize()}}markObjects(t,e,s){if(this.opt=e,!this.isArrayOfObjects(t))return this.log(`Is not array of objects ${JSON.stringify(t)}`,"error"),void this.opt.allDone(0,0,{});void 0===s&&(s=0);this.processArray(t,e,s,{marks:0,matches:0,termStats:{}},[])}processArray(t,e,s,r,o){this.opt=e;const a=t[s],i=(t,e)=>{o.push({text:`Non-valid ${t} - `,obj:e,skip:!0,level:"error"}),n()},n=()=>{t[s+1]?this.processArray(t,e,s+1,r,o):(this.report(o),this.opt.allDone(r.marks,r.matches,r.termStats))};if(!a||!this.isObject(a))return void i(`object at index ${s}`,a);const c=a.method?a.method:"mark",h=a.search,l=` in '${c}' method at index ${s} - `,d=Object.assign({},e,a.options),p=d.done;switch(a.context&&(this.ctx=a.context,this.cacheDict={}),d.done=(t,e,s)=>{if("unmark"!==c&&(r.marks+=t,r.matches+=e,s))for(const t in s)void 0===r.termStats[t]&&(r.termStats[t]=0),r.termStats[t]+=s[t];"function"==typeof p&&("unmark"!==c?p(t,e,s):p()),n()},c){case"mark":this.isString(h)||Array.isArray(h)?this.mark(h,d):i("search object"+l,h);break;case"markRegExp":if(this.isRegExp(h))this.markRegExp(h,d);else if(this.isObject(h)&&this.isString(h.source)){let t=h.flags;d.acrossElements&&(t=t?(-1===t.indexOf("g")&&-1===t.indexOf("y")?"g":"")+t:"g"),this.markRegExp(new RegExp(h.source,t),d)}else i("RegExp or search object"+l,h);break;case"markRanges":this.isArrayOfObjects(h)?this.markRanges(h,d):i("search object"+l,h);break;case"unmark":this.unmark(d);break;default:i(`method at index ${s}`,c)}}markRegExp(t,e){this.opt=this.checkOption(e);let s=0,r=0,o=this.opt.separateGroups?"wrapSeparateGroups":"wrapMatches";if(this.opt.acrossElements&&(o=this.opt.separateGroups?"wrapSeparateGroupsAcross":"wrapMatchesAcross",!t.global&&!t.sticky)){let e=t.toString().split("/");t=new RegExp(t.source,"g"+e[e.length-1]),this.log("RegExp is recompiled because it must have g flag")}this.log(`Searching with expression "${t}"`),this[o](t,this.opt.ignoreGroups,((t,e,s)=>this.opt.filter(t,e,r,s)),((t,e)=>{r=e.count,s++,this.opt.each(t,e)}),(e=>{0===e&&this.opt.noMatch(t),this.opt.done(s,e)}))}mark(t,s){if(s&&s.combinePatterns)return void this.markCombinePatterns(t,s);this.opt=this.checkOption(s);let r=0,o=0,a=0,i=0;const n=new e(this.opt),c=this.opt.acrossElements?"wrapMatchesAcross":"wrapMatches",h={},l=this.getSeachTerms(t),d=t=>{const e=n.create(t);let s=0;this.log(`Searching with expression "${e}"`),this[c](e,1,((e,r,o)=>(a=i+s,this.opt.filter(e,t,a,s,o))),((t,e)=>{s=e.count,o++,this.opt.each(t,e)}),(e=>{i+=e,0===e&&this.opt.noMatch(t),h[t]=e,++r<l.length?d(l[r]):this.opt.done(o,i,h)}))};0===l.length?this.opt.done(0,0,h):d(l[r])}markCombinePatterns(t,e){this.opt=this.checkOption(e);let s,r,o=0,a=0,i=0,n=[],c=[];const h=this.opt.acrossElements,l=h?"wrapMatchesAcross":"wrapMatches",d="g"+(this.opt.caseSensitive?"":"i"),p={},u=this.getSeachTerms(t),g=t=>{const e=new RegExp(t,d),u=c[o];this.log(`Searching with expression "${e}"`),this[l](e,1,((t,e,o)=>(h?o.matchStart&&(s=this.getCurrentTerm(o.match,u)):s=this.getCurrentTerm(o.match,u),r=p[s],this.opt.filter(t,s,i+r,r,o))),((t,e)=>{a++,h?e.matchStart&&(p[s]+=1):p[s]+=1,this.opt.each(t,e)}),(t=>{i+=t;const e=u.filter((t=>0===p[t]));e.length&&this.opt.noMatch(e),++o<n.length?g(n[o]):this.opt.done(a,i,p)}))};if(0===u.length)this.opt.done(0,0,p);else{u.forEach((t=>{p[t]=0}));const t=this.getPatterns(u);c=t.termsParts,n=t.patterns,g(n[o])}}getCurrentTerm(t,e){let s=t.length;for(;--s>2;)if(t[s])return e[s-3];return" "}getPatterns(t){const s=new e(this.opt),r=s.create(t[0],!0),o=this.opt.combinePatterns,a=[],i=[];let n,c=10;o===1/0?c=Math.pow(2,31):this.isNumeric(o)&&(n=parseInt(o))>0&&(c=n);let h=Math.ceil(t.length/c);for(let e=0;e<h;e++){let o=r.lookbehind+"(";const n=[],h=Math.min(e*c+c,t.length);for(let s=e*c;s<h;s++)n.push(t[s]);o+=s.createCombinePattern(n,!0).pattern,a.push(o+")"+r.lookahead),i.push(n)}return{patterns:a,termsParts:i}}markRanges(t,e){if(this.opt=e,this.cacheDict={},this.isArrayOfObjects(t)){let e=0;this.wrapRanges(t,((t,e,s,r)=>this.opt.filter(t,e,s,r)),((t,s,r)=>{e++,this.opt.each(t,s,r)}),((t,s)=>{this.report(s),this.opt.done(e,t)}))}else this.report([{text:"markRanges() accept an array of objects: ",obj:t,level:"error"}]),this.opt.done(0,0)}unmark(e){this.opt=e,this.cacheDict={};let s=(this.opt.element?this.opt.element:"mark")+"[data-markjs]";this.opt.className&&(s+=`.${this.opt.className}`),this.log(`Removal selector "${s}"`),this.iterator.forEachNode(NodeFilter.SHOW_ELEMENT,(t=>{this.unwrapMatches(t)}),(e=>t.matches(e,s)&&!this.excludeElements(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT),this.opt.done)}}$.fn.mark=function(t,e){return new s(this.get()).mark(t,e),this},$.fn.markRegExp=function(t,e){return new s(this.get()).markRegExp(t,e),this},$.fn.markRanges=function(t,e){return new s(this.get()).markRanges(t,e),this},$.fn.markObjects=function(t,e,r){return new s(this.get()).markObjects(t,e,r),this},$.fn.unmark=function(t){return new s(this.get()).unmark(t),this},$.fn.getVersion=function(){return new s(this.get()).version};var r=$;export{r as default};
